<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>抽象物品 - 硬盘在歌唱</title><link rel=icon type=image/png href=favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="任意可以附加于玩家的金币、经验、道具、体力等"><meta property="og:image" content><meta property="og:title" content="抽象物品"><meta property="og:description" content="任意可以附加于玩家的金币、经验、道具、体力等"><meta property="og:type" content="article"><meta property="og:url" content="https://disksing.com/abstract-item/"><meta property="article:section" content="post"><meta property="article:published_time" content="2014-11-18T00:00:00+00:00"><meta property="article:modified_time" content="2014-11-18T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="抽象物品"><meta name=twitter:description content="任意可以附加于玩家的金币、经验、道具、体力等"><link href=https://disksing.com/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://disksing.com/css/main.40ca3a860425083862b7ebd55447caec5c4384573f0cb098b8d06a91e8dace2e.css></head><body><div class=content><header><div class=main><a href=https://disksing.com/>硬盘在歌唱</a></div><nav><a href=/>主页</a>
<a href=/post/>文章</a>
<a href=/project/>开源项目</a>
<a href=/about/>关于</a></nav></header><main><article><div class=title><h1 class=title>抽象物品</h1><div class=meta>Posted on Nov 18, 2014</div></div><section class=body><p>抽象物品这个词汇是我为了说明方便生造出来的，用于指代游戏系统中任意可以附加于玩家的东西，比如金币、宝石、经验、道具、英雄、宠物、装备、积分、体力等等，都可以用通用抽象物品接口来替代。其实抽象物品几乎所有游戏项目都在用（至少我接触过的项目都有），只是没人去正经的归纳。</p><h2 id=数据结构>数据结构</h2><p>这个东西说白了其实就是一个 union，里面包含了可能的各种数值和数据，当然了因为是 unoin 嘛，其中只有一部分会起作用。这里给出我们项目中使用 protocol buffers 定义的数据结构。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>CommonItem</span> {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>enum</span> Type {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:red;background-color:#faa></span>		Property <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>; <span style=color:#888>//数值
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#888></span>		BagItem  <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>; <span style=color:#888>//背包道具
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#888></span>		Hero     <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>; <span style=color:#888>//英雄
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#888></span>		<span style=color:#888>//...
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#888></span>	}<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> type <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:red;background-color:#faa></span>	<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>PropertyData</span> {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>enum</span> PropertyKey {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:red;background-color:#faa></span>			Gold     <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>; <span style=color:#888>//金币
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#888></span>			Gem      <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>; <span style=color:#888>//宝石
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#888></span>			Exp      <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>; <span style=color:#888>//玩家经验
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#888></span>			<span style=color:#888>//...
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#888></span>		}<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> key   <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> count <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:red;background-color:#faa></span>	}<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> PropertyData propertyData <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:red;background-color:#faa></span>	<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>BagItemData</span> {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> id    <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> count <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:red;background-color:#faa></span>	}<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> BagItemData bagItemData <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:red;background-color:#faa></span>	<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>HeroData</span> {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> id    <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> level <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> star  <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:red;background-color:#faa></span>	}<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> HeroData heroData <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>4</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:red;background-color:#faa></span>}<span style=color:red;background-color:#faa>
</span></span></span></code></pre></div><p>嗯，看上去还是挺复杂的。CommonItem 包含了一个 type 字段指明了该抽象物品的具体类型，后面是各种具体物品携带的数据，可能是玩家的某个属性值，可能是背包、英雄等，注意我们使用了 optional 选项。
当然了，也可以直接记录几个数字，第一个数字代表类型，后面几个数字的意义由类型来决定。也有直接用带分隔符的字符串来表示的。原理上来说都是类似的，我觉得使用 protocol buffers 进行结构化的表示更加直观一些。</p><h2 id=为什么做抽象>为什么做抽象</h2><p>上面也说了，这个结构是比较复杂的，而且构建和解析也会比较费劲，那么我们为什么折腾出这么个东西呢。主要有下面几个原因：</p><h3 id=1-解耦各个模块>1. 解耦各个模块</h3><p>当系统中一个模块调用另一个模块时，就产生了依赖，依赖无疑是需要我们竭力减至最小的。注意到两个模块间调用时大部时候都是在修改彼此的数据，更进一步，大部分的数据修改都在添加或消耗某些东西。比如副本掉落道具<strong>添加</strong>进背包，打副本时<strong>消耗</strong>体力，完成任务时<strong>添加</strong>经验和金币。</p><p>假如副本能同时掉落金币、经验、体力、背包物品，那么副本就同时依赖这些模块，也就是说这些模块中任意一个的接口发生变化时，我们就不得不修改副本模块的代码。再来看背包，副本、任务、宝箱、商店都会改动背包的数据，所以这些模块同时依赖于背包模块，所以如果我们改动了背包的接口，这些模块的代码都要修改。</p><p>很显然，这里是一个很不合适的 M*N 的关系。所以我们需要加一个分发模块作为“中介”，抽象物品作为“载体”。所有的调用模块都只依赖分发模块，它们只需要知道需要添加或消耗抽象物品，而不关心具体维护对应数据的模块。分发模块负责将抽象物品分发到不同的数据模块。这样一来 M*N 的关系就变成了 M+N。</p><h3 id=2-配表更加灵活>2. 配表更加灵活</h3><p>就拿副本掉落举例子。如果没有抽象物品，当策划想让副本掉落金币时，可能会在表里加一列，定义为金币。等过了几天想换成掉经验，于是通知程序修改代码……又过了几天觉得还是换成背包物品比较好，于是又多加了几列，再通知程序修改代码……更杯具的是，如果到后期新开放了积分系统，好多配表都需要添加积分这一列。这样显然不是很灵活。</p><p>如果有设计恰当的抽象物品，很多产出和消耗都可以配成抽象的物品，策划可以很灵活自由地修改数值。程序这边也很方便，只需要写一次解析抽象物品配置的代码。</p><h3 id=3-方便交换数据>3. 方便交换数据</h3><p>例如抽卡功能，服务器需要把抽出的结果返回给客户端显示，这时直接使用抽象物品这个数据结构来交换数据，定义消息接口时不用关心具体产出物品的类型。
另一方面，不管抽象物品实际是金币还是背包物品或是能量，客户端总是要以相似的形式在界面上显示出来：常见的一个图标、图标下方有物品的名字、图标的右下角是数量。有了抽象物品这个结构后，只需要正确处理好对抽象物品的显示，所有系统的界面都可以直接调用了，而不关心那个系统所要展现的具体是个什么东西。</p><h2 id=分发模块设计>分发模块设计</h2><p>分发模块上文已经大略介绍过了，可以简单地理解为一个代理，其功能是把对抽象物品的操作映射到对实际数据的操作。</p><p>分发模块主要定义这三个接口：</p><ol><li>Add(CommonItem) 添加一项抽象物品</li><li>Remove(CommonItem) 删除一项抽象物品</li><li>Has(CommonItem) 判断玩家是否拥有一份抽象物品</li></ol><p>另外一个要解决的问题是，有的数据不是直接附加于玩家本身的，比如英雄经验应该附加于某个英雄上，技能经验应该附加于某个技能上，等等。所以我们在添加一项抽象物品时，可能还需要一些额外的上下文数据（英雄 id，技能 id，宠物 id 等），这些上下文数据应该是触发操作的环境中可以获取的。例如对于打副本，上下文数据中就应该包含当前出战的英雄，副本模块应该负责将自己的上下文数据告知分发模块，以供其正确分发。</p><p>所以最后分发模块的接口这样定义：</p><ol><li>Add(CommonItem, Context) 添加一项抽象物品</li><li>Remove(CommonItem, Context) 删除一项抽象物品</li><li>Has(CommonItem, Context) 判断玩家是否拥有一份抽象物品</li></ol><p>其中 Context 中包含由调用者感知的上下文数据。可能的问题是：如果数据配置有总是，当发现要添加的抽象物品是英雄经验时，上下文数据中并不包含英雄 id（可能是开宝箱触发的），那么此时无法正确添加。坦率地说，这种问题现在想不到好的解决办法，这也是抽象统一接口所带来的代价吧！</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91>游戏开发</a></li></ul></nav></div></article></main><footer><div style=display:flex></div><div class=footer-info>2022 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154774927-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>