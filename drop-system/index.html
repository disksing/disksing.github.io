<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>掉落系统</title><link rel=icon href=http://disksing.com/favicon.png><style>html body{font-family:noto serif sc,sans-serif;background-color:#fff}:root{--accent: red;--border-width:  5px }</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto%20Serif%20SC"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script><meta name=generator content="Hugo 0.80.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154774927-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','UA-154774927-1');</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script data-ad-client=ca-pub-8963356574249468 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>掉落系统</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>主页</a></li><li><a href=/post/>文章</a></li><li><a href=/tip/>知识点</a></li><li><a href=/project/>开源项目</a></li><li><a href=/activity/>动态</a></li><li><a href=/about/>关于</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:i@disksing.com><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/disksing/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=http://weibo.com/539523448><i class="fa fa-weibo"></i></a></li><li class=navbar-icon><a href="http://shang.qq.com/wpa/qunwpa?idkey=ade2895067e4105ce59e0c56863d650543b4448245f179574c6684fe1cb7b5d5"><i class="fa fa-qq"></i></a></li><li class=navbar-icon><a href=https://space.bilibili.com/2207710><i class="fa fa-tv"></i></a></li><li class=navbar-icon><a href=https://twitter.com/disksing/><i class="fa fa-twitter"></i></a></li></ul></div></div></nav><main><div><h1>掉落系统</h1><h5>2014-11-30</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div align=start class=content><p>本文所讨论的掉落系统是一个游戏中的通用模块，不仅局限于打怪时掉落物品，包括抽卡、开宝箱、任务奖励、活动奖励等功能都可以使用。抽象地说，掉落系统是由给定参数按照特定的算法生成一系列可附加在玩家身上的东西的模块。</p><h2 id=需求>需求</h2><p>我先罗列一下整个的需求列表，会比较零乱，随后我们再来抽丝剥茧理清这里面的逻辑关系。</p><ol><li>掉落系统可以掉落任何能附加于玩家的物品。包括金币、宝石、经验、英雄经验、道具、英雄、宠物、装备、积分、体力等等。</li><li>策划需要控制掉落物品的数值。如金币宝石的数量，道具的 ID、数量，英雄的 Id、等级、星级等。</li><li>掉落物品涉及数值可能是固定的，也可能是在一定范围内随机的，也可能是根据公式计算出来的。</li><li>一次掉落可能掉落多个物品。掉落的多个物品可能是固定的，也可能是随机的。随机方式有两种：从多个物品中独立随机（针对每个物品判断概率是否命中），从多个物品中权重随机（按照一组物品概率的比例选出一个）。</li><li>特殊情况下会改变掉落。例如抽卡连续抽 10 次后提高得到更好卡的概率，打同个副本次数过多后降低产出概率。</li></ol><h2 id=使用通用物品>使用通用物品</h2><p>为了解决第 1 点需求，我们可以一份通用物品数据结构，这样就能使用统一的配置来描述各类不同的物品了。关于通用物品及相关的分发模块设计，前一篇博客<a href=http://disksing.com/abstract-item>游戏开发手记：抽象物品</a>已经做了说明，这里不再赘述。</p><h2 id=通用物品数值>通用物品数值</h2><p>有了通用物品，策划基本上可以根据需要配置上任何物品了。但有一些特殊情况要特殊处理，也就是物品的数值不一定是固定的。比如开宝箱，可能需要开出的金币有一定的随机效果，在一定的范围内随机；再如战斗产生的经验需要跟玩家的等级挂钩，玩家等级越高，所获取的经验也越高。</p><p>我们想把这些复杂性约束在掉落系统内解决，让具体逻辑写起来更简洁，也可以避免后面各个模块都过于复杂产生 bug。所以最后我们的解决方案可能有些复杂，但综合来看是可以接受的。</p><p>具体方案就是把通用物品的每一项数值扩展为 4 列（逻辑类型，参数 1，参数 2，参数 3），最后由四列综合计算出一项数值（如物品数量）。计算方式如下：</p><ol><li>逻辑类型==<code>固定数值</code>，则数值为 <code>参数1</code></li><li>逻辑类型==<code>范围随机</code>，则数值为 <code>random(min=参数1，max=参数2)</code></li><li>逻辑类型==<code>玩家等级</code>，则数值为 <code>参数1*玩家等级^2+参数2*玩家等级+参数3</code></li><li>逻辑类型==<code>VIP 等级</code>，则数值为 <code>参数1*VIP等级^2+参数2*VIP等级+参数3</code></li><li>&mldr;其他类型</li></ol><p>这样一来，基本上可以满足策划任何关于物品数值的需求。</p><h2 id=独立随机和权重随机>独立随机和权重随机</h2><p>需求中第 4 点提到了，掉落的过程是从一系列预先配置的物品中选择一项或多项，选择的过程可能是独立随机或权重随机。我们的做法是把随机的过程划分成多个阶段，第一个阶段进行独立随机，第二个阶段进行权重随机，这样一来策划只需要根据自己的需求进行组合配置，程序这边来看逻辑是统一的。</p><p>具体地说，一个 dropId 对应多个 DropGroup，每个 DropGroup 都带有一个命中概率。第一阶段我们拿到 dropId 后遍历其对应的所有 DropGroup 并依次检查概率是否命中，命中则被选出。每个 DropGroup 又对应多个 DropDetail，每个 DropDetail 带有对应的 DropItem 和其随机权重。第二阶段我们从上面计算出的每个 DropGroup 中按照权重随机选择一项 DropDetail。</p><h2 id=掉落的转换>掉落的转换</h2><p>第 5 点需求掉落的改变可以换个角度来认知，我们把需求理解成：一个 dropId 可能在某些条件下转变为另一个 dropId。比如抽 10 次卡提高得到好卡的概率，可以配置两份掉落，一份对应于低概率，一份对应于高概率，正常情况下掉落低概率，当低概率的次数是整 10 时则转为高概率。</p><p>在我们的游戏中，掉落的转换总是跟掉落的次数息息相关的。我们定义了一份 transform 配置，其中指明某 dropId 在何种条件下变为另一个 dropId。游戏运行过程中记录 transform 表中出现的 dropId 的掉落次数，在掉落生成之前检查并进行转换，再用转换后的 dropId 生成真正的掉落。</p><p>配表的结构大致是这样的：</p><table><thead><tr><th>FromDropId</th><th>Operator</th><th>Value</th><th>ToDropId</th></tr></thead><tbody><tr><td>1001</td><td>></td><td>100</td><td>1003</td></tr><tr><td>1001</td><td>%</td><td>5</td><td>1002</td></tr><tr><td>1002</td><td>=</td><td>10</td><td>1003</td></tr><tr><td>1003</td><td>&lt;</td><td>50</td><td>1004</td></tr></tbody></table><p>解释一下。掉落 1001 在掉落次数大于 100 次时则改为掉落 1003，否则每生成 5 次改为掉落 1002；掉落 1002 在第 10 次改为 1003；掉落 1003 在生成次数小于 50 时总是转为 1004。</p><p>转换 dropId 时先递增该 dropId 的掉落次数，再检查该 id 的所有转换条件，若条件满足则转为新的 dropId，递增新的 dropId 次数后再检查转换条件，一直到不能再进行转换为止。</p><h2 id=总结>总结</h2><p>最后再整理一下完整的生成掉落的过程。</p><ol><li>由产生掉落的模块提供 dropId 交给掉落系统。</li><li>掉落系统尝试对 dropId 进行转换，并递增涉及 dropId 的掉落次数，最后返回新的 dropId（大部分情况下与原来的相同）。</li><li>依照 dropId 查出对应的一个或多个 DropGroup，依次进行概率判定，最后选出一个或多个 DropGroup。</li><li>对于每个 DropGroup，查出其对应的一个或多个 DropDetail，依照权重选出一项 DropDetail。</li><li>对于每项 DropDetail，计算其配置的数值并生成一项通用物品。</li><li>收集所有生成的通用物品，即为此次掉落的产出。</li></ol></div><hr><b>欢迎加入技术讨论 QQ 群：</b> 481269635 （硬盘在歌唱）<h4 class=page-header>Comments</h4><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"disksing"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h4 class=page-header>Related</h4><div class=item><h4><a href=/pb-on-gamedev/>Protocol Buffers 在游戏中的应用</a></h4><h5>挖掘 PB 的潜能</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div class=item><h4><a href=/game-i18n/>游戏国际化的一些建议</a></h4><h5>2015-04-08</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div class=item><h4><a href=/design-change/>策划总改需求怎么办？</a></h4><h5>程序和策划是不应该有隔阂的</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div></main><footer></footer><p class="copyright text-muted">&copy; 2014-2021 ALL RIGHTS RESERVED
|
本站由 <a href=https://gohugo.io>Hugo</a> 和 <a href=https://github.com/calintat/minimal>Minimal</a> 强力驱动
|
<a href=http://disksing.com/post/index.xml target=_blank><i class="fa fa-rss-square"></i>订阅本站文章</a> <a href=http://github.com/disksing/disksing.github.io/issues/new target=_blank><i class="fa fa-bug"></i>反馈问题</a><br>若无特别说明，本站文章采用 <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> 进行许可，文中涉及代码采用 <a rel=license href=http://creativecommons.org/publicdomain/zero/1.0/>CC0 1.0 Universal</a> 进行许可</p><script>MathJax={tex:{inlineMath:[['$','$']],displayMath:[['$$','$$']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></body></html>