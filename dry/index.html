<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>重复的代码都应该被消除吗？</title><link rel=icon href=http://disksing.com/favicon.png><style>html body{font-family:noto serif sc,sans-serif;background-color:#fff}:root{--accent:red;--border-width:5px}</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto%20Serif%20SC"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><meta name=generator content="Hugo 0.94.2"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154774927-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-154774927-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script data-ad-client=ca-pub-8963356574249468 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>重复的代码都应该被消除吗？</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>主页</a></li><li><a href=/post/>文章</a></li><li><a href=/tip/>知识点</a></li><li><a href=/project/>开源项目</a></li><li><a href=/activity/>动态</a></li><li><a href=/about/>关于</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:i@disksing.com><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/disksing/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=http://weibo.com/539523448><i class="fa fa-weibo"></i></a></li><li class=navbar-icon><a href="http://shang.qq.com/wpa/qunwpa?idkey=ade2895067e4105ce59e0c56863d650543b4448245f179574c6684fe1cb7b5d5"><i class="fa fa-qq"></i></a></li><li class=navbar-icon><a href=https://space.bilibili.com/2207710><i class="fa fa-tv"></i></a></li><li class=navbar-icon><a href=https://twitter.com/disksing/><i class="fa fa-twitter"></i></a></li></ul></div></div></nav><main><div><h1>重复的代码都应该被消除吗？</h1><h5>2020-07-22</h5><a href=http://disksing.com/tags/%E6%9D%82%E8%B0%88><kbd class=item-tag>杂谈</kbd></a></div><div align=start class=content><p>昨天，我们项目组同事给测试代码做了些重构和梳理，总体上是很好的，不过有一个地方我觉得其实不如原本的好。</p><p>这段代码是在单测里虚拟一个集群添加一些节点，原来的代码是这样的（无关细节略作调整）：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>testCluster <span style=color:#333>:=</span> mockcluster.<span style=color:#06b;font-weight:700>NewCluster</span>(opt)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>1</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>2</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>3</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>4</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>5</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z3&#34;</span>})
</span></span></code></pre></div><p>优化过之后的代码是这样的：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>testCluster <span style=color:#333>:=</span> mockcluster.<span style=color:#06b;font-weight:700>NewCluster</span>(opt)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>allStores <span style=color:#333>:=</span> []<span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    storeID     <span style=color:#339;font-weight:700>uint64</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    regionCount <span style=color:#339;font-weight:700>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    labels      <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {<span style=color:#00d;font-weight:700>1</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {<span style=color:#00d;font-weight:700>2</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {<span style=color:#00d;font-weight:700>3</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    {<span style=color:#00d;font-weight:700>4</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {<span style=color:#00d;font-weight:700>5</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z3&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#080;font-weight:700>for</span> _, store <span style=color:#333>:=</span> <span style=color:#080;font-weight:700>range</span> allStores {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(store.storeID, store.regionCount, store.labels)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span></code></pre></div><p>令我比较诧异的是，团队里面有一半以上的人都觉得新版本更好，这让我觉得有必要写写这个问题好好整理一下我的理由。</p><p>认为新版更好的理由主要有 2 点：</p><ol><li>旧版本重复了多次 <code>AddLabelStore</code> 这个方法调用，新版本不存在重复代码，更加优雅。</li><li>新版本对修改更加友好，如果测试逻辑变成调用 <code>AddLabelStore</code> 之后要加入其他逻辑，新版只用改一个地方。</li></ol><hr><p>我先解释一下为什么这两点理由是不成立的。</p><h3 id=重复代码未必糟糕>重复代码未必糟糕</h3><p>大家都听说过 DRY（Don&rsquo;t Repeat Yourself）原则，不过很少有人知道这个原则原本并不是针对重复代码。</p><blockquote><p>Every piece of knowledge must have a single, unambiguous, authoritative representation within a system.</p></blockquote><p>注意这里说的是 knowlege 而不是 code。有几个层面的区别：</p><p>其一，代码可能并不形成知识。比如上面的例子，重复的部分只是函数调用而已，而函数调用传的参数，每次调用都各不相同，即使使用新版本的方法进行抽象，这些参数还是以一个列表的形式列举了出来，并没有通过整理形成任何公共的知识。</p><p>其二，重复的代码可能是不同的知识。<a href=https://verraes.net/2014/08/dry-is-about-knowledge/>DRY is about Knowlege</a> 一文举了一个很好的例子：两件商品都限购 3 份，但这更多只是巧合，本质上两个不同的知识，因而不能去消除重复代码。</p><h3 id=提前设计的弊端>提前设计的弊端</h3><p>第 2 个理由还是比较有道理的，可惜只有在未来真的需要做这样的修改时才成立。如果未来并不会产生如预期一样的修改，甚至过了一段时间整个测试用例都可能被删掉了，那么我们就是白白付出了精力做这个重构。</p><p>更重要的是，新版本的代码更不易读（后面分析），每次被阅读时，都会多消耗一份心智负担。即使最终真的发现要如预期般修改了，在此之前所付出的额外精力也是浪费的。</p><p>另外，未来如果真要在每个 <code>AddLabelStore</code> 后面加几行别的逻辑，未必没有其他更好做法。比如直接在 <code>AddLabelStore</code> 之内修改，或者提取一个新函数把 <code>AddLabelStore</code> 包装一下，完全没有必要现在就提前做决定。</p><p>我一直有一个观点，好的代码应该“活在当下”。既不应该为过去的错误长期买单，也不应该为未来的需要提前透支。</p><hr><h3 id=kiss>KISS</h3><p>KISS（Keep It Simple, Stupid）不仅适用于软件开发，是整个设计领域都通用的经验原则。简单地说就是应该注重简约，避免引入不必要的复杂度。</p><p>新版本的代码复杂在什么地方呢？</p><p>最简单地判断依据是，新版本的代码更长。或者严谨一点说，新版本代码在没有显著降低单行代码理解成本的前提下，完全相同的功能使用了更多代码，因而阅读起来要付出更多的精力。</p><p>我们还可以这么来看。尝试把两份代码试着用自然语言来描述，会发现后者会长得多。为了干同样的事情，新版本引入了一个匿名结构体，一个数组，一个 for 循环，这显然会给读者带来理解上的心智负担，而且在我看来很难说是优雅。</p><p>反观旧版代码，没使用精巧的结构和复杂的设计，但是清晰地表达了意图，一眼看上去就知道在干什么，而且显然没什么隐藏的问题。我认为是更好的选择。</p></div><hr><b>欢迎加入技术讨论 QQ 群：</b> 481269635 （硬盘在歌唱）<h4 class=page-header>Comments</h4><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//disksing.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h4 class=page-header>Related</h4><div class=item><h4><a href=/story2001/>一个小故事，关于科幻，关于老师</a></h4><h5>2020-09-10</h5><a href=http://disksing.com/tags/%E6%9D%82%E8%B0%88><kbd class=item-tag>杂谈</kbd></a></div><div class=item><h4><a href=/beancount/>beancount 复式记账实践</a></h4><h5>2020-08-20</h5><a href=http://disksing.com/tags/%E6%9D%82%E8%B0%88><kbd class=item-tag>杂谈</kbd></a></div><div class=item><h4><a href=/ncov-testing/>如何快速检测新冠病毒</a></h4><h5>2020-06-16</h5><a href=http://disksing.com/tags/%E7%AE%97%E6%B3%95><kbd class=item-tag>算法</kbd></a>
<a href=http://disksing.com/tags/%E6%9D%82%E8%B0%88><kbd class=item-tag>杂谈</kbd></a></div></main><footer></footer><p class="copyright text-muted">&copy; 2014-2022 ALL RIGHTS RESERVED
|
本站由 <a href=https://gohugo.io>Hugo</a> 和 <a href=https://github.com/calintat/minimal>Minimal</a> 强力驱动
|
<a href=http://disksing.com/post/index.xml target=_blank><i class="fa fa-rss-square"></i>订阅本站文章</a> <a href=http://github.com/disksing/disksing.github.io/issues/new target=_blank><i class="fa fa-bug"></i>反馈问题</a><br>若无特别说明，本站文章采用 <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> 进行许可，文中涉及代码采用 <a rel=license href=http://creativecommons.org/publicdomain/zero/1.0/>CC0 1.0 Universal</a> 进行许可</p><script>MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></body></html>