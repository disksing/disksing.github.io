<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>TrueTime和原子钟</title><link rel=icon href=http://disksing.com/favicon.png><style>:root{--accent:red;--border-width:5px}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><style>body{font-family:lxgw wenkai lite,sans-serif}pre,code{font-family:lxgw wenkai mono,sans-serif}</style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><meta name=generator content="Hugo 0.110.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154774927-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-154774927-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script data-ad-client=ca-pub-8963356574249468 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>TrueTime和原子钟</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>主页</a></li><li><a href=/post/>文章</a></li><li><a href=/tip/>知识点</a></li><li><a href=/project/>开源项目</a></li><li><a href=/activity/>动态</a></li><li><a href=/about/>关于</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:i@disksing.com><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/disksing/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=http://weibo.com/539523448><i class="fa fa-weibo"></i></a></li><li class=navbar-icon><a href="http://shang.qq.com/wpa/qunwpa?idkey=ade2895067e4105ce59e0c56863d650543b4448245f179574c6684fe1cb7b5d5"><i class="fa fa-qq"></i></a></li><li class=navbar-icon><a href=https://space.bilibili.com/2207710><i class="fa fa-tv"></i></a></li><li class=navbar-icon><a href=https://twitter.com/disksing/><i class="fa fa-twitter"></i></a></li></ul></div></div></nav><main><div><h1>TrueTime和原子钟</h1><h5>2021-02-10</h5><a href=http://disksing.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F><kbd class=item-tag>分布式系统</kbd></a>
<a href=http://disksing.com/tags/tidb><kbd class=item-tag>TiDB</kbd></a></div><div align=start class=content><p>如果你关注分布式数据库，相信多少听说过Google的分布式数据库Spanner，以及Spanner使用原子钟搞了一套TrueTime来实现跨数据中心的分布式事务。</p><p>而Spanner的后继者们，却都采用了不使用原子钟替代方案，比如TiDB的TSO，CockroachDB的HLC。对此很多人的印象就是Google财大气粗，所以有能力搞原子钟这种精密高端设备。这个说法不能说全错，但至少不是完全准确的。</p><h2 id=网络时钟同步>网络时钟同步</h2><p>上面提到的3种取时间戳的方式的底层逻辑是迥然不同的。TiDB的TSO是中心授时，每一个时间戳都要从中心服务器获取；CockroachDB的HLC本质上是逻辑时钟，依赖于消息交换时去推进时钟计数器；Spanner的TrueTime是时钟同步，通过定期交换消息，把本地时钟与源时钟进行同步。</p><p>时钟同步的模式跟我们日常用手表的方法是类似的，我们隔一段时间把手表跟新闻联播同步一下，期间的时间直接从手表上读出来。</p><p>计算机里面最常见的时钟同步就是NTP了，通过网络同步时钟有个问题就是延迟导致的误差。</p><figure style=text-align:center><img src=/assets/img/tt1.png><figcaption align=center><h6>网络同步时钟</h6></figcaption></figure><p>比如客户端在12:00:00发起查询请求，2秒钟后收到服务器的消息，返回的时间也是12:00:00。这时并不意味着本地时钟是准确的，因为消息发到服务器要花费时间，本地时钟实际上是快了一点。但是具体快了多少是没法知道的，我们只知道消息一来一回花了2秒，却不知道来回分别花了多长时间。因此只能大概估摸着取个中间值，把时间往回拨1秒，这时误差范围就是±1秒了。</p><h2 id=marzullo算法>Marzullo算法</h2><p>只从单一时间源同步时间是不够靠谱的。除了有可能发生故障或者网络中断，更可怕的是时间源本身就出了问题。<a href=https://en.wikipedia.org/wiki/Marzullo%27s_algorithm>Marzullo算法</a>就是用来从多个时间源来估算准确时间的算法。</p><figure style=text-align:center><img src=/assets/img/tt2.png><figcaption align=center><h6>Marzullo算法</h6></figcaption></figure><p>如图，我们通过向ABCD四个时间源查询时间分别得到时钟偏差及误差范围，算法的大体思路就是选被尽可能多时间源所覆盖的区间（缩小误差范围），并排除掉有问题的区间（如A）。</p><p>不过，在对时序有严格要求的场景（比如分布式事务），Marzullo算法还要进行一些改良。例如比较明显的缺陷是，当有问题的时间源offset区间与正常的区间有交叠时，可能导致误差范围被估算得过小。如果想了解相关细节，可以去研究下<a href=http://infolab.stanford.edu/pub/cstr/reports/csl/tr/83/247/CSL-TR-83-247.pdf>相关资料</a>，这里不展开了。</p><h2 id=时钟漂移>时钟漂移</h2><p>跟服务器对上时间了还没完，通常对时的过程都要周期性地触发。正如我们的手表用着用着就不准了，CPU的晶振周期也不是完全精确的，会受温度和电压的影响，时间一长也会“跑偏”。</p><p>Spanner假设他家服务器的误差不超过每秒钟200μs。按最大值去计算，30秒不同步，误差最多会累计到6ms，如果1天不同步，最大误差达到约为17s。要注意这里的误差范围是非常非常保守的，实际情况CPU远不可能这么糟糕，举个例子对比一下，我国石英电子表的行业标准是，一类月差10-15秒，二类月差20-30秒。</p><h2 id=原子钟>原子钟</h2><blockquote><p>原子钟，是一种利用原子、分子能级差为基准信号来校准晶体振荡器或激光器频率，以使其输出标准频率信号的一种装置。它的工作原理是：利用原子吸收或释放能量时发出的电磁波来计时的。由于这种电磁波非常稳定，再加上利用一系列精密的仪器进行控制，原子钟的计时就可以非常准确了，可以达到千万年仅差一秒或者更好的水平。</p><p>—— <a href=http://pdf.dfcfw.com/pdf/H3_AP201811141245494502_1.PDF>时间频率：5G 叠加自主可控， 被忽视的高精尖领域</a></p></blockquote><p>看上去确实很高端，那么假如想买这样一个原子钟要多少钱呢？实际情况是原子钟比听上去亲民的多，我们直接在东哥的网站上<a href=https://www.jd.com/jiage/5025da214207cb4b44a8.html>就能搜到</a>：</p><figure style=text-align:center><img src=/assets/img/tt6.png><figcaption align=center><h6>京东商城售卖的原子钟</h6></figcaption></figure><p>售价大约是几万到十几万不等，并非承受不起的昂贵，和一台高端点的服务器是差不多的价位，如果降低精度的要求还能更便宜。</p><p>说白了原子钟和计算机上面随处可见的晶振就是同一类东西，只不过精度高了好几个数量级。</p><figure style=text-align:center><img src=/assets/img/tt3.png><figcaption align=center><h6>不同硬件的计时精确度</h6></figcaption></figure><p>需要注意有些同学误认为TrueTime需要每台机器都要给配一个原子钟，其实不用，一个数据中心有几个就完全足够了，具体先按下不表后面再说。</p><h2 id=gps授时>GPS授时</h2><p>GPS不仅提供定位服务，还可以授时。每个GPS卫星都携带了数个高精度原子钟，并不断广播星历（运行轨迹）和时间。地面装置从至少4颗卫星接收到信号后，解开以三维空间+一维时间为变量的四元方程组，就能同时拿到时间空间信息了。</p><p>GPS的精度非常之高，可以把误差控制在数纳秒以内。这是因为电磁波信号基本上是直线传播，路径上受到的干扰很小，根据距离可以很准确地计算出信号传递延时。而网络消息会受中继和多层网络层层封包的影响，而且即便在光纤中，信号也不是沿直线传播的。</p><h2 id=truetime>TrueTime</h2><p>背景知识介绍完毕，下面我们就来看看TrueTime到底是怎么做的。</p><figure style=text-align:center><img src=/assets/img/tt4.png><figcaption align=center><h6>机房内的TrueTime组件部署</h6></figcaption></figure><p>TrueTime组件按角色分成 time master 和 time daemon。time master 可以认为是 TrueTime 的服务端，部署在一些独立的机器上，time daemon 是客户端，以进程的形式部署在每个实际运行业务的主机上。</p><p>time master 又分成两类。一类安装 GPS 模块，分散在机房的不同位置，每个GPS节点都使用独立的天线，避免因为信号干扰的原因一起失效了。另一类安装的是原子钟，原子钟也是多台来防止故障产生不可用。</p><p>各种 time master 周期性地使用Marzullo算法相互对时，每个 time daemon 也会以 30 秒为周期跟多个 time master 进行对时（同样使用Marzullo算法）。</p><p>之前介绍过，GPS 的精度是纳秒级别的，这个误差跟机房内的网络延迟比起来都可以忽略不计了，直接计作0ms。这样time daemon进行时钟同步之后的误差就仅仅取决于网络延迟了，一般机房内不超过1ms。</p><p>我们还要考虑到完成时钟同步之后，到下一次同步期间time daemon的时钟漂移，也就是前面计算过的，30秒内最大误差可能累计到6ms。于是，time daemon上的时钟误差范围就在1ms到7ms之间不断涨落，画出来是这样的锯齿状：</p><figure style=text-align:center><img src=/assets/img/tt5.png><figcaption align=center><h6>time daemon误差范围变化示意</h6></figcaption></figure><p>那么问题来了，原子钟是干啥用的？</p><p>简而言之，原子钟是GPS的备胎。GPS授时容易受天气和电磁信号的干扰，极端情况下还有可能整个GPS系统故障了，或者由于战争等原因被关掉服务（须知GPS是军用设施），这时原子钟才会派上用场。</p><p>论文里没细写，不过推测一下，原子钟跟GPS节点同步逻辑应该是跟time daemon类似的，即效果也是周期性地回落至1ms附近。区别在于，当GPS失效之后，原子钟的误差增长速度要远远小于普通机器，因此可以取而代之，作为数据中心的数据源离线提供时钟同步服务。</p><h2 id=总结>总结</h2><p>回到最初的问题：为什么只有Spanner使用了TrueTime的设计？这并不是因为原子钟有多么的遥不可及。TrueTime是一整套精巧复杂的设施，原子钟只是其中一个有些关键的组成部分。</p><p>拿TiDB来说，我们没有资源和机会去从零设计搭建完整的机房来支撑这一套系统，只能选择替代方案。但是TrueTime的设计理念和思想是值得我们去学习和吸收的！</p><p>TrueTime最大的贡献在于，把时间误差范围作为API提供给上层，配合事务层面的精心设计来达成苛刻的事务一致性。我们既不能从根本上消除误差，也无法确切地计算误差范围，但是巧妙地以确定的误差上界为突破点，优雅地解决问题！</p><p>分布式系统最动人的美妙之处就在这里：我们面对的是令人近乎绝望的不确定性，然而凭着信念，理性，智慧，我们又能在如此脆弱的基础之上搭建出高度可靠的，不容置疑的系统。</p><p>收工！</p><hr><p><em><strong>参考资料</strong></em></p><ul><li><a href=https://static.googleusercontent.com/media/research.google.com/zh-CN//archive/spanner-osdi2012.pdf>Spanner: Google’s Globally-Distributed Database</a></li><li><a href=https://en.wikipedia.org/wiki/Marzullo%27s_algorithm>Marzullo&rsquo;s algorithm</a></li><li><a href=http://infolab.stanford.edu/pub/cstr/reports/csl/tr/83/247/CSL-TR-83-247.pdf>Maintaining the time in a distributed system</a></li><li><a href=http://pdf.dfcfw.com/pdf/H3_AP201811141245494502_1.PDF>时间频率：5G叠加自主可控，被忽视的高精尖领域</a></li><li><a href=https://juejin.cn/post/6844903788822659086>分布式系统中时钟的问题</a></li><li><a href=http://blog.sciencenet.cn/blog-402265-1003430.html>原子钟那点事</a></li><li><a href=http://www.xbd-time.com/news/news146.html>GPS授时装置授时原理和授时精度分析</a></li><li><a href=https://ying-zhang.github.io/yi/2017/x-spanner-truetime-cap/>Spanner, TrueTime 和CAP理论</a></li></ul></div><hr><b>欢迎加入技术讨论 QQ 群：</b> 745157974<h4 class=page-header>Comments</h4><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//disksing.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h4 class=page-header>Related</h4><div class=item><h4><a href=/tidb-gateway/>给TiDB（MySQL）写一个代理网关</a></h4><h5>引入数据库网关来优化TiDB Cloud服务运营成本的故事，以及处理MySQL协议的糟心细节</h5><a href=http://disksing.com/tags/tidb><kbd class=item-tag>TiDB</kbd></a>
<a href=http://disksing.com/tags/mysql><kbd class=item-tag>MySQL</kbd></a>
<a href=http://disksing.com/tags/serverless><kbd class=item-tag>serverless</kbd></a></div><div class=item><h4><a href=/dual-datacenter-master-slave/>双中心主从模式</a></h4><h5>2021-09-11</h5><a href=http://disksing.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F><kbd class=item-tag>分布式系统</kbd></a></div><div class=item><h4><a href=/ya-hackathon-idea/>价值6万元的TiDB Hackathon创意</a></h4><h5>2020-12-17</h5><a href=http://disksing.com/tags/tidb><kbd class=item-tag>TiDB</kbd></a></div></main><footer></footer><p class="copyright text-muted">&copy; 2014-2023 ALL RIGHTS RESERVED
|
本站由 <a href=https://gohugo.io>Hugo</a> 和 <a href=https://github.com/calintat/minimal>Minimal</a> 强力驱动
|
<a href=http://disksing.com/post/index.xml target=_blank><i class="fa fa-rss-square"></i>订阅本站文章</a> <a href=http://github.com/disksing/disksing.github.io/issues/new target=_blank><i class="fa fa-bug"></i>反馈问题</a><br>若无特别说明，本站文章采用 <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> 进行许可，文中涉及代码采用 <a rel=license href=http://creativecommons.org/publicdomain/zero/1.0/>CC0 1.0 Universal</a> 进行许可</p><script>MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></body></html>