<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>重复的代码都应该被消除吗？ - 硬盘在歌唱</title><link rel=icon type=image/png href=favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="昨天，我们项目组同事给测试代码做了些重构和梳理，总体上是很好的，不过有一个地方我觉得其实不如原本的好。 这段代码是在单测里虚拟一个集群添加一些"><meta property="og:image" content><meta property="og:title" content="重复的代码都应该被消除吗？"><meta property="og:description" content="昨天，我们项目组同事给测试代码做了些重构和梳理，总体上是很好的，不过有一个地方我觉得其实不如原本的好。 这段代码是在单测里虚拟一个集群添加一些"><meta property="og:type" content="article"><meta property="og:url" content="https://disksing.com/dry/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-07-22T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="重复的代码都应该被消除吗？"><meta name=twitter:description content="昨天，我们项目组同事给测试代码做了些重构和梳理，总体上是很好的，不过有一个地方我觉得其实不如原本的好。 这段代码是在单测里虚拟一个集群添加一些"><link href=https://disksing.com/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://disksing.com/css/main.40ca3a860425083862b7ebd55447caec5c4384573f0cb098b8d06a91e8dace2e.css></head><body><div class=content><header><div class=main><a href=https://disksing.com/>硬盘在歌唱</a></div><nav><a href=/>主页</a>
<a href=/post/>文章</a>
<a href=/about/>关于</a></nav></header><main><article><div class=title><h1 class=title>重复的代码都应该被消除吗？</h1><div class=meta>Posted on Jul 22, 2020</div></div><section class=body><p>昨天，我们项目组同事给测试代码做了些重构和梳理，总体上是很好的，不过有一个地方我觉得其实不如原本的好。</p><p>这段代码是在单测里虚拟一个集群添加一些节点，原来的代码是这样的（无关细节略作调整）：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>testCluster <span style=color:#333>:=</span> mockcluster.<span style=color:#06b;font-weight:700>NewCluster</span>(opt)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>1</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>2</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>3</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>4</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(<span style=color:#00d;font-weight:700>5</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z3&#34;</span>})
</span></span></code></pre></div><p>优化过之后的代码是这样的：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>testCluster <span style=color:#333>:=</span> mockcluster.<span style=color:#06b;font-weight:700>NewCluster</span>(opt)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>allStores <span style=color:#333>:=</span> []<span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    storeID     <span style=color:#339;font-weight:700>uint64</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    regionCount <span style=color:#339;font-weight:700>int</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    labels      <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {<span style=color:#00d;font-weight:700>1</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {<span style=color:#00d;font-weight:700>2</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z1&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {<span style=color:#00d;font-weight:700>3</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    {<span style=color:#00d;font-weight:700>4</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z2&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {<span style=color:#00d;font-weight:700>5</span>, <span style=color:#00d;font-weight:700>1</span>, <span style=color:#080;font-weight:700>map</span>[<span style=color:#339;font-weight:700>string</span>]<span style=color:#339;font-weight:700>string</span>{<span style=background-color:#fff0f0>&#34;zone&#34;</span>: <span style=background-color:#fff0f0>&#34;z3&#34;</span>}},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#080;font-weight:700>for</span> _, store <span style=color:#333>:=</span> <span style=color:#080;font-weight:700>range</span> allStores {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    testCluster.<span style=color:#06b;font-weight:700>AddLabelsStore</span>(store.storeID, store.regionCount, store.labels)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span></code></pre></div><p>令我比较诧异的是，团队里面有一半以上的人都觉得新版本更好，这让我觉得有必要写写这个问题好好整理一下我的理由。</p><p>认为新版更好的理由主要有 2 点：</p><ol><li>旧版本重复了多次 <code>AddLabelStore</code> 这个方法调用，新版本不存在重复代码，更加优雅。</li><li>新版本对修改更加友好，如果测试逻辑变成调用 <code>AddLabelStore</code> 之后要加入其他逻辑，新版只用改一个地方。</li></ol><hr><p>我先解释一下为什么这两点理由是不成立的。</p><h3 id=重复代码未必糟糕>重复代码未必糟糕</h3><p>大家都听说过 DRY（Don&rsquo;t Repeat Yourself）原则，不过很少有人知道这个原则原本并不是针对重复代码。</p><blockquote><p>Every piece of knowledge must have a single, unambiguous, authoritative representation within a system.</p></blockquote><p>注意这里说的是 knowlege 而不是 code。有几个层面的区别：</p><p>其一，代码可能并不形成知识。比如上面的例子，重复的部分只是函数调用而已，而函数调用传的参数，每次调用都各不相同，即使使用新版本的方法进行抽象，这些参数还是以一个列表的形式列举了出来，并没有通过整理形成任何公共的知识。</p><p>其二，重复的代码可能是不同的知识。<a href=https://verraes.net/2014/08/dry-is-about-knowledge/>DRY is about Knowlege</a> 一文举了一个很好的例子：两件商品都限购 3 份，但这更多只是巧合，本质上两个不同的知识，因而不能去消除重复代码。</p><h3 id=提前设计的弊端>提前设计的弊端</h3><p>第 2 个理由还是比较有道理的，可惜只有在未来真的需要做这样的修改时才成立。如果未来并不会产生如预期一样的修改，甚至过了一段时间整个测试用例都可能被删掉了，那么我们就是白白付出了精力做这个重构。</p><p>更重要的是，新版本的代码更不易读（后面分析），每次被阅读时，都会多消耗一份心智负担。即使最终真的发现要如预期般修改了，在此之前所付出的额外精力也是浪费的。</p><p>另外，未来如果真要在每个 <code>AddLabelStore</code> 后面加几行别的逻辑，未必没有其他更好做法。比如直接在 <code>AddLabelStore</code> 之内修改，或者提取一个新函数把 <code>AddLabelStore</code> 包装一下，完全没有必要现在就提前做决定。</p><p>我一直有一个观点，好的代码应该“活在当下”。既不应该为过去的错误长期买单，也不应该为未来的需要提前透支。</p><hr><h3 id=kiss>KISS</h3><p>KISS（Keep It Simple, Stupid）不仅适用于软件开发，是整个设计领域都通用的经验原则。简单地说就是应该注重简约，避免引入不必要的复杂度。</p><p>新版本的代码复杂在什么地方呢？</p><p>最简单地判断依据是，新版本的代码更长。或者严谨一点说，新版本代码在没有显著降低单行代码理解成本的前提下，完全相同的功能使用了更多代码，因而阅读起来要付出更多的精力。</p><p>我们还可以这么来看。尝试把两份代码试着用自然语言来描述，会发现后者会长得多。为了干同样的事情，新版本引入了一个匿名结构体，一个数组，一个 for 循环，这显然会给读者带来理解上的心智负担，而且在我看来很难说是优雅。</p><p>反观旧版代码，没使用精巧的结构和复杂的设计，但是清晰地表达了意图，一眼看上去就知道在干什么，而且显然没什么隐藏的问题。我认为是更好的选择。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/%E6%9D%82%E8%B0%88>杂谈</a></li></ul></nav></div></article></main><footer><div style=display:flex></div><div class=footer-info>2022 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-154774927-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>