<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>抽象物品</title><link rel=icon href=http://disksing.com/favicon.png><style>html body{font-family:noto serif sc,sans-serif;background-color:#fff}:root{--accent: red;--border-width:  5px }</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto%20Serif%20SC"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script><meta name=generator content="Hugo 0.80.0"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154774927-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','UA-154774927-1');</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script data-ad-client=ca-pub-8963356574249468 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>抽象物品</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>主页</a></li><li><a href=/post/>文章</a></li><li><a href=/tip/>知识点</a></li><li><a href=/project/>开源项目</a></li><li><a href=/activity/>动态</a></li><li><a href=/about/>关于</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:i@disksing.com><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/disksing/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=http://weibo.com/539523448><i class="fa fa-weibo"></i></a></li><li class=navbar-icon><a href="http://shang.qq.com/wpa/qunwpa?idkey=ade2895067e4105ce59e0c56863d650543b4448245f179574c6684fe1cb7b5d5"><i class="fa fa-qq"></i></a></li><li class=navbar-icon><a href=https://space.bilibili.com/2207710><i class="fa fa-tv"></i></a></li><li class=navbar-icon><a href=https://twitter.com/disksing/><i class="fa fa-twitter"></i></a></li></ul></div></div></nav><main><div><h1>抽象物品</h1><h5>2014-11-18</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div align=start class=content><p>抽象物品这个词汇是我为了说明方便生造出来的，用于指代游戏系统中任意可以附加于玩家的东西，比如金币、宝石、经验、道具、英雄、宠物、装备、积分、体力等等，都可以用通用抽象物品接口来替代。其实抽象物品几乎所有游戏项目都在用（至少我接触过的项目都有），只是没人去正经的归纳。</p><h2 id=数据结构>数据结构</h2><p>这个东西说白了其实就是一个 union，里面包含了可能的各种数值和数据，当然了因为是 unoin 嘛，其中只有一部分会起作用。这里给出我们项目中使用 protocol buffers 定义的数据结构。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>CommonItem</span> {<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>enum</span> Type {<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:red;background-color:#faa></span>		Property <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>; <span style=color:#888>//数值
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#888></span>		BagItem  <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>; <span style=color:#888>//背包道具
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#888></span>		Hero     <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>; <span style=color:#888>//英雄
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#888></span>		<span style=color:#888>//...
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#888></span>	}<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> type <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:red;background-color:#faa></span>	<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>PropertyData</span> {<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>enum</span> PropertyKey {<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:red;background-color:#faa></span>			Gold     <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>; <span style=color:#888>//金币
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#888></span>			Gem      <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>; <span style=color:#888>//宝石
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#888></span>			Exp      <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>; <span style=color:#888>//玩家经验
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#888></span>			<span style=color:#888>//...
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#888></span>		}<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> key   <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> count <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:red;background-color:#faa></span>	}<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> PropertyData propertyData <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:red;background-color:#faa></span>	<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>BagItemData</span> {<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> id    <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> count <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span style=color:red;background-color:#faa></span>	}<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> BagItemData bagItemData <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:red;background-color:#faa></span>	<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>HeroData</span> {<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> id    <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> level <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span style=color:red;background-color:#faa></span>		<span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> star  <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span style=color:red;background-color:#faa></span>	}<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>optional</span> HeroData heroData <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>4</span>;<span style=color:red;background-color:#faa>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span style=color:red;background-color:#faa></span>}<span style=color:red;background-color:#faa>
</span></code></pre></div><p>嗯，看上去还是挺复杂的。CommonItem 包含了一个 type 字段指明了该抽象物品的具体类型，后面是各种具体物品携带的数据，可能是玩家的某个属性值，可能是背包、英雄等，注意我们使用了 optional 选项。
当然了，也可以直接记录几个数字，第一个数字代表类型，后面几个数字的意义由类型来决定。也有直接用带分隔符的字符串来表示的。原理上来说都是类似的，我觉得使用 protocol buffers 进行结构化的表示更加直观一些。</p><h2 id=为什么做抽象>为什么做抽象</h2><p>上面也说了，这个结构是比较复杂的，而且构建和解析也会比较费劲，那么我们为什么折腾出这么个东西呢。主要有下面几个原因：</p><h3 id=1-解耦各个模块>1. 解耦各个模块</h3><p>当系统中一个模块调用另一个模块时，就产生了依赖，依赖无疑是需要我们竭力减至最小的。注意到两个模块间调用时大部时候都是在修改彼此的数据，更进一步，大部分的数据修改都在添加或消耗某些东西。比如副本掉落道具<strong>添加</strong>进背包，打副本时<strong>消耗</strong>体力，完成任务时<strong>添加</strong>经验和金币。</p><p>假如副本能同时掉落金币、经验、体力、背包物品，那么副本就同时依赖这些模块，也就是说这些模块中任意一个的接口发生变化时，我们就不得不修改副本模块的代码。再来看背包，副本、任务、宝箱、商店都会改动背包的数据，所以这些模块同时依赖于背包模块，所以如果我们改动了背包的接口，这些模块的代码都要修改。</p><p>很显然，这里是一个很不合适的 M*N 的关系。所以我们需要加一个分发模块作为“中介”，抽象物品作为“载体”。所有的调用模块都只依赖分发模块，它们只需要知道需要添加或消耗抽象物品，而不关心具体维护对应数据的模块。分发模块负责将抽象物品分发到不同的数据模块。这样一来 M*N 的关系就变成了 M+N。</p><h3 id=2-配表更加灵活>2. 配表更加灵活</h3><p>就拿副本掉落举例子。如果没有抽象物品，当策划想让副本掉落金币时，可能会在表里加一列，定义为金币。等过了几天想换成掉经验，于是通知程序修改代码……又过了几天觉得还是换成背包物品比较好，于是又多加了几列，再通知程序修改代码……更杯具的是，如果到后期新开放了积分系统，好多配表都需要添加积分这一列。这样显然不是很灵活。</p><p>如果有设计恰当的抽象物品，很多产出和消耗都可以配成抽象的物品，策划可以很灵活自由地修改数值。程序这边也很方便，只需要写一次解析抽象物品配置的代码。</p><h3 id=3-方便交换数据>3. 方便交换数据</h3><p>例如抽卡功能，服务器需要把抽出的结果返回给客户端显示，这时直接使用抽象物品这个数据结构来交换数据，定义消息接口时不用关心具体产出物品的类型。
另一方面，不管抽象物品实际是金币还是背包物品或是能量，客户端总是要以相似的形式在界面上显示出来：常见的一个图标、图标下方有物品的名字、图标的右下角是数量。有了抽象物品这个结构后，只需要正确处理好对抽象物品的显示，所有系统的界面都可以直接调用了，而不关心那个系统所要展现的具体是个什么东西。</p><h2 id=分发模块设计>分发模块设计</h2><p>分发模块上文已经大略介绍过了，可以简单地理解为一个代理，其功能是把对抽象物品的操作映射到对实际数据的操作。</p><p>分发模块主要定义这三个接口：</p><ol><li>Add(CommonItem) 添加一项抽象物品</li><li>Remove(CommonItem) 删除一项抽象物品</li><li>Has(CommonItem) 判断玩家是否拥有一份抽象物品</li></ol><p>另外一个要解决的问题是，有的数据不是直接附加于玩家本身的，比如英雄经验应该附加于某个英雄上，技能经验应该附加于某个技能上，等等。所以我们在添加一项抽象物品时，可能还需要一些额外的上下文数据（英雄 id，技能 id，宠物 id 等），这些上下文数据应该是触发操作的环境中可以获取的。例如对于打副本，上下文数据中就应该包含当前出战的英雄，副本模块应该负责将自己的上下文数据告知分发模块，以供其正确分发。</p><p>所以最后分发模块的接口这样定义：</p><ol><li>Add(CommonItem, Context) 添加一项抽象物品</li><li>Remove(CommonItem, Context) 删除一项抽象物品</li><li>Has(CommonItem, Context) 判断玩家是否拥有一份抽象物品</li></ol><p>其中 Context 中包含由调用者感知的上下文数据。可能的问题是：如果数据配置有总是，当发现要添加的抽象物品是英雄经验时，上下文数据中并不包含英雄 id（可能是开宝箱触发的），那么此时无法正确添加。坦率地说，这种问题现在想不到好的解决办法，这也是抽象统一接口所带来的代价吧！</p></div><hr><b>欢迎加入技术讨论 QQ 群：</b> 481269635 （硬盘在歌唱）<h4 class=page-header>Comments</h4><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"disksing"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h4 class=page-header>Related</h4><div class=item><h4><a href=/pb-on-gamedev/>Protocol Buffers 在游戏中的应用</a></h4><h5>挖掘 PB 的潜能</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div class=item><h4><a href=/game-i18n/>游戏国际化的一些建议</a></h4><h5>2015-04-08</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div class=item><h4><a href=/design-change/>策划总改需求怎么办？</a></h4><h5>程序和策划是不应该有隔阂的</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div></main><footer></footer><p class="copyright text-muted">&copy; 2014-2021 ALL RIGHTS RESERVED
|
本站由 <a href=https://gohugo.io>Hugo</a> 和 <a href=https://github.com/calintat/minimal>Minimal</a> 强力驱动
|
<a href=http://disksing.com/post/index.xml target=_blank><i class="fa fa-rss-square"></i>订阅本站文章</a> <a href=http://github.com/disksing/disksing.github.io/issues/new target=_blank><i class="fa fa-bug"></i>反馈问题</a><br>若无特别说明，本站文章采用 <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> 进行许可，文中涉及代码采用 <a rel=license href=http://creativecommons.org/publicdomain/zero/1.0/>CC0 1.0 Universal</a> 进行许可</p><script>MathJax={tex:{inlineMath:[['$','$']],displayMath:[['$$','$$']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></body></html>