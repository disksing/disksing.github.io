<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>游戏逻辑模块组织及数据同步</title><link rel=icon href=http://disksing.com/favicon.png><style>html body{font-family:noto serif sc,sans-serif;background-color:#fff}:root{--accent:red;--border-width:5px}</style><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto%20Serif%20SC"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><meta name=generator content="Hugo 0.97.3"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154774927-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-154774927-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script data-ad-client=ca-pub-8963356574249468 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>游戏逻辑模块组织及数据同步</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>主页</a></li><li><a href=/post/>文章</a></li><li><a href=/tip/>知识点</a></li><li><a href=/project/>开源项目</a></li><li><a href=/activity/>动态</a></li><li><a href=/about/>关于</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:i@disksing.com><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/disksing/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=http://weibo.com/539523448><i class="fa fa-weibo"></i></a></li><li class=navbar-icon><a href="http://shang.qq.com/wpa/qunwpa?idkey=ade2895067e4105ce59e0c56863d650543b4448245f179574c6684fe1cb7b5d5"><i class="fa fa-qq"></i></a></li><li class=navbar-icon><a href=https://space.bilibili.com/2207710><i class="fa fa-tv"></i></a></li><li class=navbar-icon><a href=https://twitter.com/disksing/><i class="fa fa-twitter"></i></a></li></ul></div></div></nav><main><div><h1>游戏逻辑模块组织及数据同步</h1><h5>2014-09-28</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div align=start class=content><p>一个游戏根据功能可以划分为多个不同的模块，如金钱、背包、装备、技能、任务、成就等。按照软件工程的思想，我们希望分而治之单独实现不同的模块，再将这些模块组合在一起成为一份完整的游戏。但现实是残酷的，不同模块之间往往有千丝万缕的联系，比如购买背包物品会需要扣金币、打一个副本会完成任务，完成任务又会奖励金币和物品，金币的增加又导致一个成就达成。于是我们虽然在不同的类或不同的文件中来实现各个模块，却免不了模块间的交叉引用和互相调用，最后混杂不堪，任何一点小修改都可以导致牵一发而动全身。</p><p>为了后面说明方便，我们考虑这样一个小型游戏系统：总共有 3 个模块，分别是金钱、背包、任务。购买背包物品需要消耗金币，卖出背包物品可得到金币，金币增加到一定数额后会导致某个任务的状态变为完成，完成任务可获得物品和金币。这 3 个模块的调用关系如图。</p><p><img src=/assets/img/module-sync-1.png alt=1></p><p>首先我们把模块的数据和逻辑分离，借鉴经典的 MVC 模式，数据部分叫作 Model，逻辑部分叫作 Controller。如此一来，游戏功能部分就被划分出来了两个不同的层次，Controller 处于较高的层次上，可以引用一个或者多个 Model。Model 层专心处理数据，对上层无感知。每个 Model 都是完全独立的模块，不引用任何 Controller 或 Model，不依赖于其他任何对象，可以单拿出来进行单元测试。</p><p><img src=/assets/img/module-sync-2.png alt=2></p><p>对于我们的例子，每个模块提供的接口列举如下：</p><p>BagModel：获取物品数量，增加物品，扣除物品</p><p>MoneyModel：获取金币数量，增加金币，扣除金币</p><p>TaskModel：增加任务，删除任务，标记任务为完成</p><p>BagController：购买物品，卖出物品</p><p>TaskController：完成任务</p><p>购买或卖出物品时，由 BagController 进行或操作校验，随后调用 BagModel 和 MoneyModel 完成数据修改。完成任务时，由 TaskController 调用各个模块。</p><p>现在唯一的问题是，既然 MoneyModel 不引用其他模块，那么在金币增加时如何告知任务模块去完成任务呢？这里我们需要引入一个管理依赖的利器：观察者模式。</p><p>具体使用方式是把 Model 实现为一个 Subject，对某个 Model 的数据变化感兴趣的 Controller 实现为对应的 Observer。我们的例子中，MoneyModel 是 Subject，在金币数量变化时通知所有已注册的 Observer；TaskController 是 MoneyModel 的一个 Observer，在初始化时向 MoneyModel 注册。</p><p><img src=/assets/img/module-sync-3.png alt=3></p><p>注意图中由 MoneyModel 指向 TaskController 的虚线箭头，代表 MoneyModel 数据变化时会去通知 TaskController，用虚线是因为 MoneyModel 并不依赖于 TaskController（只依赖于 Observer 接口）。同样 BagModel 也可以提供背包物品变化的 Subject，如果新加一个任务是要求某物品的数量达某个值，那么 TaskController 可向 BagModel 注册，这样在物品变化时就能得到通知了，图中也画出了这条虚线。</p><p>对观察者模式不熟悉的读者朋友可以自行查阅资料， 本文的重点并不是介绍设计模式。这里简单提示一下观察者模式的精髓：当某模块调用其他模块时就产生了依赖，这时可以不直接去调用，而是转而实现一个机制，这个机制就是让其他模块告诉自己他们需要被调用。最后调用的流程没变，变化的是依赖关系。</p><p>在客户端情况要更复杂一些，实际上加入 UI 后，我们的模块设计就成经典的 MVC，这也是我们为什么把数据模块和逻辑模块分别叫 Model 和 Controller 的原因。</p><p><img src=/assets/img/module-sync-4.png alt=4></p><p>这里只画出了背包模块。这里的 System API 指与游戏运行平台相关的一些接口，可能是操作系统 API、引擎 API、图形库 API 等等。View 模块和 Model 模块地位相当，只处理显示而不管游戏功能，需要显示的数据都是由 Controller 提供的。对于能输入的 View 同样采用观察者模式，点击等事件发生时通知其他模块（而不是直接调用），注意图中由 BagView 指向 BagController 的虚线箭头。</p><p>下面介绍数据同步的设计。</p><p>首先对于网络游戏，客户端所展示的数据是服务器传送过来的。当玩家操作导致数据发生变化时，最好也由服务器更新给客户端。曾经接手过一个项目，很多操作的结果都是客户端先算出来的，于是各种逻辑都是服务器和客户端各实现一遍，很容易两边的数据就不一致了，很让人头疼。</p><p>所以我们的同步思路是当客户端向服务器发起一个请求时，服务器将所有变化的数据同步给客户端，客户端收到服务器的返回后再更新数据，绝不私自改动数据。在这个指导思想下，我们消息包结构是这样的（以物品卖出举例）：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>BagItemSellCG</span> {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:red;background-color:#faa></span>    <span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> id <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:red;background-color:#faa></span>    opitnoal <span style=color:#339;font-weight:700>int32</span> count <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:red;background-color:#faa></span>}<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:red;background-color:#faa></span><span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>BagItemSellGC</span> {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:red;background-color:#faa></span>    <span style=color:#080;font-weight:700>optional</span> <span style=color:#339;font-weight:700>int32</span> result <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:red;background-color:#faa></span>    <span style=color:#080;font-weight:700>optional</span> Sync sync <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:red;background-color:#faa></span>    opitonal BagItemSellCG postback <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>3</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:red;background-color:#faa></span>}<span style=color:red;background-color:#faa>
</span></span></span></code></pre></div><p>服务器向客户端返回的消息几乎总是包含 3 个字段。result 为操作结果可能是 0 或者错误码，sync 中包含了所有的数据更新，postback 将客户端的请求消息原封不动返回去，便于客户端进行界面更新或友好提示。</p><p>sync 是一个比较复杂的 message，包含了所有需要更新的 Model 的数据。感谢 Protocol Buffer 的 optional 选项，大多数情况下我们发送的数据只是其中很小的一部分。</p><p>先来看服务器端消息处理和同步的设计。</p><p><img src=/assets/img/module-sync-5.png alt=5></p><p>如图所示，我们在 Model 和 Controller 之上新加了一个 Handler 接口层。Handler 负责解析消息包，调用 Controller 处理消息包，在必要的时候调用 SyncController 构建同步数据，最后打包成消息返回给客户端。</p><p>每个 Model 在管理数据的基础上会维护变化数据的集合，对于简单的 Model 比如 MoneyModel 就是一个 bool 脏标记，而 BagModel 则维护变化物品 id 的集合。变化数据列表在同步之后清除。</p><p>客户端的结构是类似的。</p><p><img src=/assets/img/module-sync-6.png alt=6></p><p>与服务器的区别就在于 SyncController 是负责调用 Model 更新数据，每个 Model 都实现数据更新接口。注意除 SyncController 之外，其他 Controller 只能读取 Model 而不能改变其数据，这样就保证了所有数据一定是从服务器同步的。</p><p>最后我想以出售物品为例子完整走一遍流程。从客户端进行操作开始，到请求发到服务器，最后再返回客户端更新数据和界面。完整的图比较复杂，混在一起基本上没法看了，只好删掉了客户端的任务模块……</p><p><img src=/assets/img/module-sync-7.png alt=7></p><ol><li>BagView 界面产生一个点击，因为 BagController 是 BagView 的观察者，所以 BagController 能得到点击事件的通知。</li><li>BagController 识别出此点击是要出售物品，于是构建好消息包发往服务器。</li><li>服务器识别出消息类型是 Sell，于是消息被派发给 SellHandler。</li><li>SellHandler 调用 BagController 执行逻辑。</li><li>BagController 取出 BagModel 和 MoneyModel 的数据进行条件检查，如果无法执行操作则生成错误码返回给 SellHandler，否则调用 Model 修改数据，此时 BagModel 会记录下变化物品的 id，MoneyModel 会做一个脏标记。</li><li>MoneyModel 数据发生变化，通知自己的观察者（TaskController）。</li><li>TaskController 判断任务完成，调用 TaskModel 更新数据。TaskModel 会记录发生变化的任务。</li><li>SellHandler 对 BagController 的调用返回后，如果出错则直接返回消息包给客户端。否则调用 SyncController 收集同步数据。</li><li>SyncController 调用各个模块收集同步数据，各个模块提交同步数据后清除自己维护的标记。</li><li>SellHandler 将操作结果和同步数据打包后发往客户端。</li><li>客户端识别出消息类型是 Sell，消息被派发给 SellHandler。</li><li>BagHandler 将消息处理结果发给 BagController。</li><li>BagController 根据消息处理结果，通知 BagView 进行必要的提示。</li><li>SellHandler 将消息包中的数据同步部分发给 SyncController。</li><li>SyncController 将同步数据同步给各个模块。</li><li>BagModel 和 MoneyModel 的数据发生了变化，通知观察者，即对应的Controller。</li><li>Controller 调用View 进行界面更新。</li></ol><hr><h2 id=qa>Q&A</h2><h3 id=返回客户端提交的-postback-对于网络传输来说太过重量级-可以尝试改为客户端保存一个-rid-postback-的键值对-id-由客户端自增-请求数据时把-rid-一起发送给服务器>返回客户端提交的 postback 对于网络传输来说太过重量级, 可以尝试改为客户端保存一个 rid-postback 的键值对, id 由客户端自增, 请求数据时把 rid 一起发送给服务器</h3><p>支持你的方案。</p><p>但我的想法不是出于数据量的考虑，因为一般网游客户端发往服务器的消息都是比较小的，服务器返回的消息会比较大。
原因是后来我们考虑到消息可能丢包的问题，当丢包发生时，客户端需要重发请求，这样一来 rid 检验及保存之前发送的请求就是必须的了。而保存下来的请求正好又可以用来替代上文的 postback ，所以你的方案非常合理。</p><h3 id=我使用了背包里一个物品在返回的-sync-中是返回使用掉的物品信息-还是背包的全部物品信息>我使用了背包里一个物品,在返回的 sync 中是返回使用掉的物品信息, 还是背包的全部物品信息?</h3><p>因为我们背包里的物品会比较多，所以同步全部物品是不合适的。</p><p>我们的做法是删除物品后记录物品 id，生成同步数据时如果发现对应 id 的物品不存在，则同步一个数量为 0 的物品信息，客户端收到数量为 0 的物品后做删除操作。
有的模块没有一个代表删除的特殊“零值”，比如任务。我们的做法是将新增/更新与删除分开同步：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#080;font-weight:700>message</span> <span style=color:#b06;font-weight:700>TaskSync</span> {<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>repeated</span> Task update <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:red;background-color:#faa></span>	<span style=color:#080;font-weight:700>repeated</span> <span style=color:#339;font-weight:700>int32</span> delete <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>2</span>;<span style=color:red;background-color:#faa>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:red;background-color:#faa></span>}<span style=color:red;background-color:#faa>
</span></span></span></code></pre></div></div><hr><b>欢迎加入技术讨论 QQ 群：</b> 481269635 （硬盘在歌唱）<h4 class=page-header>Comments</h4><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//disksing.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h4 class=page-header>Related</h4><div class=item><h4><a href=/pb-on-gamedev/>Protocol Buffers 在游戏中的应用</a></h4><h5>挖掘 PB 的潜能</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div class=item><h4><a href=/game-i18n/>游戏国际化的一些建议</a></h4><h5>2015-04-08</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div><div class=item><h4><a href=/design-change/>策划总改需求怎么办？</a></h4><h5>程序和策划是不应该有隔阂的</h5><a href=http://disksing.com/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91><kbd class=item-tag>游戏开发</kbd></a></div></main><footer></footer><p class="copyright text-muted">&copy; 2014-2022 ALL RIGHTS RESERVED
|
本站由 <a href=https://gohugo.io>Hugo</a> 和 <a href=https://github.com/calintat/minimal>Minimal</a> 强力驱动
|
<a href=http://disksing.com/post/index.xml target=_blank><i class="fa fa-rss-square"></i>订阅本站文章</a> <a href=http://github.com/disksing/disksing.github.io/issues/new target=_blank><i class="fa fa-bug"></i>反馈问题</a><br>若无特别说明，本站文章采用 <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> 进行许可，文中涉及代码采用 <a rel=license href=http://creativecommons.org/publicdomain/zero/1.0/>CC0 1.0 Universal</a> 进行许可</p><script>MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></body></html>