<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Go 语言设计模式：组合</title><link rel=icon href=http://disksing.com/favicon.png><style>:root{--accent:red;--border-width:5px}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=/css/main.css><style>body{font-family:lxgw wenkai lite,sans-serif}pre,code{font-family:lxgw wenkai mono,sans-serif}</style><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script>$(document).on("click",function(){$(".collapse").collapse("hide")})</script><meta name=generator content="Hugo 0.111.2"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154774927-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-154774927-1")</script><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script data-ad-client=ca-pub-8963356574249468 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>Go 语言设计模式：组合</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>主页</a></li><li><a href=/post/>文章</a></li><li><a href=/tip/>知识点</a></li><li><a href=/project/>开源项目</a></li><li><a href=/story/>故事</a></li><li><a href=/about/>关于</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:i@disksing.com><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/disksing/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=http://weibo.com/539523448><i class="fa fa-weibo"></i></a></li><li class=navbar-icon><a href="http://shang.qq.com/wpa/qunwpa?idkey=ade2895067e4105ce59e0c56863d650543b4448245f179574c6684fe1cb7b5d5"><i class="fa fa-qq"></i></a></li><li class=navbar-icon><a href=https://space.bilibili.com/2207710><i class="fa fa-tv"></i></a></li><li class=navbar-icon><a href=https://twitter.com/disksing/><i class="fa fa-twitter"></i></a></li></ul></div></div></nav><main><div><h1>Go 语言设计模式：组合</h1><h5>2014-11-17</h5><a href=http://disksing.com/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80><kbd class=item-tag>编程语言</kbd></a>
<a href=http://disksing.com/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1><kbd class=item-tag>系统设计</kbd></a></div><div align=start class=content><p>GoF 对组合模式的定义是，<strong>将对象组合成树形结构以表示“部分整体”的层次结构，组合模式使得用户对单个对象和组合对象的使用具有一致性</strong>。</p><p>对于这句话我是有异议的，这里先卖个关子，我们先从实际例子说起。</p><p>组合模式的例子大家都见得很多了，比如文件系统（文件/文件夹）、GUI 窗口（Frame/Control）、菜单（菜单/菜单项）等等，我这里也举个菜单的例子，不过不是操作系统里的菜单，是真正的菜单，KFC 的……</p><p>姑且把 KFC 里的食物认为是<code>菜单项</code>，一份套餐是<code>菜单</code>。菜单和菜单项有一些公有属性：名字、描述、价格、都能被购买等，所以正如 GoF 所说，我们需要一致性地使用它们。它们的层次结构体现在一个菜单里会包含多个菜单项或菜单，其价格是所有子项的和。嗯，这个例子其实不是很恰当，不能很好的体现菜单包含菜单的情况，所以我多定义了一个“超值午餐”菜单，其中包含若干个套餐。</p><p>用代码归纳总结一下，最终我们的调用代码是这样的：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	menu1 <span style=color:#333>:=</span> <span style=color:#06b;font-weight:700>NewMenu</span>(<span style=background-color:#fff0f0>&#34;培根鸡腿燕麦堡套餐&#34;</span>, <span style=background-color:#fff0f0>&#34;供应时间：09:15--22:44&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	menu1.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;主食&#34;</span>, <span style=background-color:#fff0f0>&#34;培根鸡腿燕麦堡1个&#34;</span>, <span style=color:#60e;font-weight:700>11.5</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	menu1.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;小吃&#34;</span>, <span style=background-color:#fff0f0>&#34;玉米沙拉1份&#34;</span>, <span style=color:#60e;font-weight:700>5.0</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	menu1.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;饮料&#34;</span>, <span style=background-color:#fff0f0>&#34;九珍果汁饮料1杯&#34;</span>, <span style=color:#60e;font-weight:700>6.5</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	menu2 <span style=color:#333>:=</span> <span style=color:#06b;font-weight:700>NewMenu</span>(<span style=background-color:#fff0f0>&#34;奥尔良烤鸡腿饭套餐&#34;</span>, <span style=background-color:#fff0f0>&#34;供应时间：09:15--22:44&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	menu2.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;主食&#34;</span>, <span style=background-color:#fff0f0>&#34;新奥尔良烤鸡腿饭1份&#34;</span>, <span style=color:#60e;font-weight:700>15.0</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	menu2.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;小吃&#34;</span>, <span style=background-color:#fff0f0>&#34;新奥尔良烤翅2块&#34;</span>, <span style=color:#60e;font-weight:700>11.0</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	menu2.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;饮料&#34;</span>, <span style=background-color:#fff0f0>&#34;芙蓉荟蔬汤1份&#34;</span>, <span style=color:#60e;font-weight:700>4.5</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	all <span style=color:#333>:=</span> <span style=color:#06b;font-weight:700>NewMenu</span>(<span style=background-color:#fff0f0>&#34;超值午餐&#34;</span>, <span style=background-color:#fff0f0>&#34;周一至周五有售&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	all.<span style=color:#06b;font-weight:700>Add</span>(menu1)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	all.<span style=color:#06b;font-weight:700>Add</span>(menu2)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	all.<span style=color:#06b;font-weight:700>Print</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span></code></pre></div><p>得到的输出如下：</p><pre tabindex=0><code>超值午餐, 周一至周五有售, ￥53.50
------------------------
培根鸡腿燕麦堡套餐, 供应时间：09:15--22:44, ￥23.00
------------------------
  主食, ￥11.50
    -- 培根鸡腿燕麦堡1个
  小吃, ￥5.00
    -- 玉米沙拉1份
  饮料, ￥6.50
    -- 九珍果汁饮料1杯

奥尔良烤鸡腿饭套餐, 供应时间：09:15--22:44, ￥30.50
------------------------
  主食, ￥15.00
    -- 新奥尔良烤鸡腿饭1份
  小吃, ￥11.00
    -- 新奥尔良烤翅2块
  饮料, ￥4.50
    -- 芙蓉荟蔬汤1份
</code></pre><h2 id=面向对象实现>面向对象实现</h2><p><em>先说明一下：Go 语言不是面向对象语言，实际上只有 struct 而没有类或对象。但是为了说明方便，后面我会使用<code>类</code>这个术语来表示 struct 的定义，用<code>对象</code>这个术语来表示 struct 实例。</em></p><p>按照惯例，先使用经典的面向对象来分析。首先我们需要定义菜单和菜单项的抽象基类，这样使用者就可以只依赖于接口了，于是实现使用上的一致性。</p><p>Go 语言中没有继承，所以我们把抽象基类定义为接口，后面会由菜单和菜单项实现具体功能：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> MenuComponent <span style=color:#080;font-weight:700>interface</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	<span style=color:#06b;font-weight:700>Name</span>() <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	<span style=color:#06b;font-weight:700>Description</span>() <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#06b;font-weight:700>Price</span>() <span style=color:#339;font-weight:700>float32</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	<span style=color:#06b;font-weight:700>Print</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#06b;font-weight:700>Add</span>(MenuComponent)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	<span style=color:#06b;font-weight:700>Remove</span>(<span style=color:#339;font-weight:700>int</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#06b;font-weight:700>Child</span>(<span style=color:#339;font-weight:700>int</span>) MenuComponent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><p>菜单项的实现：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> MenuItem <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	name        <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	description <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	price       <span style=color:#339;font-weight:700>float32</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>NewMenuItem</span>(name, description <span style=color:#339;font-weight:700>string</span>, price <span style=color:#339;font-weight:700>float32</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	<span style=color:#080;font-weight:700>return</span> <span style=color:#333>&amp;</span>MenuItem{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>		name:        name,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		description: description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		price:       price,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Name</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#080;font-weight:700>return</span> m.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Description</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#080;font-weight:700>return</span> m.description
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Price</span>() <span style=color:#339;font-weight:700>float32</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	<span style=color:#080;font-weight:700>return</span> m.price
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Print</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	fmt.<span style=color:#06b;font-weight:700>Printf</span>(<span style=background-color:#fff0f0>&#34;  %s, ￥%.2f\n&#34;</span>, m.name, m.price)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>	fmt.<span style=color:#06b;font-weight:700>Printf</span>(<span style=background-color:#fff0f0>&#34;    -- %s\n&#34;</span>, m.description)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Add</span>(MenuComponent) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>	<span style=color:#007020>panic</span>(<span style=background-color:#fff0f0>&#34;not implement&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Remove</span>(<span style=color:#339;font-weight:700>int</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>	<span style=color:#007020>panic</span>(<span style=background-color:#fff0f0>&#34;not implement&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Child</span>(<span style=color:#339;font-weight:700>int</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>	<span style=color:#007020>panic</span>(<span style=background-color:#fff0f0>&#34;not implement&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>}
</span></span></code></pre></div><p>有两点请留意一下。</p><ol><li>NewMenuItem() 创建的是 MenuItem，但返回的是抽象的接口 MenuComponent。（面向对象中的多态）</li><li>因为 MenuItem 是叶节点，无法提供 Add() Remove() Child()这三个方法的实现，所以若被调用会 panic。</li></ol><p>下面是菜单的实现：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> Menu <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	name        <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	description <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	children    []MenuComponent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>NewMenu</span>(name, description <span style=color:#339;font-weight:700>string</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>	<span style=color:#080;font-weight:700>return</span> <span style=color:#333>&amp;</span>Menu{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>		name:        name,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		description: description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Name</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	<span style=color:#080;font-weight:700>return</span> m.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Description</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#080;font-weight:700>return</span> m.description
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Price</span>() (price <span style=color:#339;font-weight:700>float32</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	<span style=color:#080;font-weight:700>for</span> _, v <span style=color:#333>:=</span> <span style=color:#080;font-weight:700>range</span> m.children {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		price <span style=color:#333>+=</span> v.<span style=color:#06b;font-weight:700>Price</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	<span style=color:#080;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Print</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	fmt.<span style=color:#06b;font-weight:700>Printf</span>(<span style=background-color:#fff0f0>&#34;%s, %s, ￥%.2f\n&#34;</span>, m.name, m.description, m.<span style=color:#06b;font-weight:700>Price</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>	fmt.<span style=color:#06b;font-weight:700>Println</span>(<span style=background-color:#fff0f0>&#34;------------------------&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>	<span style=color:#080;font-weight:700>for</span> _, v <span style=color:#333>:=</span> <span style=color:#080;font-weight:700>range</span> m.children {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>		v.<span style=color:#06b;font-weight:700>Print</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	fmt.<span style=color:#06b;font-weight:700>Println</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Add</span>(c MenuComponent) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>	m.children = <span style=color:#007020>append</span>(m.children, c)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Remove</span>(idx <span style=color:#339;font-weight:700>int</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>	m.children = <span style=color:#007020>append</span>(m.children[:idx], m.children[idx<span style=color:#333>+</span><span style=color:#00d;font-weight:700>1</span>:]<span style=color:#333>...</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Child</span>(idx <span style=color:#339;font-weight:700>int</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>	<span style=color:#080;font-weight:700>return</span> m.children[idx]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>}
</span></span></code></pre></div><p>其中 <code>Price()</code> 统计所有子项的 <code>Price</code> 后加和，<code>Print()</code> 输出自身的信息后依次输出所有子项的信息。另注意 <code>Remove()</code> 的实现（从 slice 中删除一项）。</p><p>好，现在针对这份实现思考下面 3 个问题。</p><ol><li><code>MenuItem</code> 和<code>Menu</code> 中都有 name、description 这两个属性和方法，重复写两遍明显冗余。如果使用其它任何面向对象语言，这两个属性和方法都应该移到基类中实现。可是 Go 没有继承，这可真是坑爹。</li><li>这里我们真正实现了<strong>用户一致性访问</strong>了吗？显然没有，当使用者拿到一个 <code>MenuComponent</code> 后，依然要知道其类型后才能正确使用，假如不加判断在 <code>MenuItem</code> 使用 <code>Add()</code> 等未实现的方法就会产生 panic。类似地，我们大可以把文件夹/文件都抽象成“文件系统节点”，可以读取名字，可以计算占用空间，但是一旦我们想往“文件系统节点”中添加子节点时，还是必须得判断它到底是不是文件夹。</li><li>接着第 2 条继续思考：产生某种<strong>一致性访问</strong>现象的本质原因是什么？一种观点： <code>Menu</code> 和 <code>MenuItem</code> 某种本质上是（is-a）同一个事物（<code>MenuComponent</code>），所以可以对它们一致性访问；另一种观点：<code>Menu</code> 和 <code>MenuItem</code> 是两个不同的事物，只是恰巧有一些相同的属性，所以可以对它们一致性访问。</li></ol><h2 id=用组合代替继承>用组合代替继承</h2><p>前面说到 Go 语言没有继承，本来属于基类的 name 和 description 不能放到基类中实现。其实只要转换一下思路，这个问题是很容易用组合解决的。如果我们认为 <code>Menu</code> 和 <code>MenuItem</code> 本质上是两个不同的事物，只是恰巧有（has-a）一些相同的属性，那么将相同的属性抽离出来，再分别组合进两者，问题就迎刃而解了。</p><p>先看抽离出来的属性：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> MenuDesc <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	name        <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	description <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuDesc) <span style=color:#06b;font-weight:700>Name</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#080;font-weight:700>return</span> m.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuDesc) <span style=color:#06b;font-weight:700>Description</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#080;font-weight:700>return</span> m.description
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>改写 <code>MenuItem</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> MenuItem <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	MenuDesc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	price <span style=color:#339;font-weight:700>float32</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>NewMenuItem</span>(name, description <span style=color:#339;font-weight:700>string</span>, price <span style=color:#339;font-weight:700>float32</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#080;font-weight:700>return</span> <span style=color:#333>&amp;</span>MenuItem{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		MenuDesc: MenuDesc{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>			name:        name,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>			description: description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>		price: price,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#888>// ... 方法略 ...
</span></span></span></code></pre></div><p>改写 <code>Menu</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> Menu <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	MenuDesc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	children []MenuComponent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>NewMenu</span>(name, description <span style=color:#339;font-weight:700>string</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#080;font-weight:700>return</span> <span style=color:#333>&amp;</span>Menu{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		MenuDesc: MenuDesc{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>			name:        name,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>			description: description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#888>// ... 方法略 ...
</span></span></span></code></pre></div><p><strong>Go 语言中善用组合有助于表达数据结构的意图</strong>。特别是当一个比较复杂的对象同时处理几方面的事情时，将对象拆成独立的几个部分再组合到一起，会非常清晰优雅。例如上面的 <code>MenuItem</code> 就是描述+价格，<code>Menu</code> 就是描述+子菜单。</p><p>其实对于 <code>Menu</code>，更好的做法是把 <code>children</code> 和 <code>Add()</code> <code>Remove()</code> <code>Child()</code> 也提取封装后再进行组合，这样 <code>Menu</code> 的功能一目了然。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> MenuGroup <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	children []MenuComponent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Add</span>(c MenuComponent) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	m.children = <span style=color:#007020>append</span>(m.children, c)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Remove</span>(idx <span style=color:#339;font-weight:700>int</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>	m.children = <span style=color:#007020>append</span>(m.children[:idx], m.children[idx<span style=color:#333>+</span><span style=color:#00d;font-weight:700>1</span>:]<span style=color:#333>...</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Child</span>(idx <span style=color:#339;font-weight:700>int</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>	<span style=color:#080;font-weight:700>return</span> m.children[idx]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#080;font-weight:700>type</span> Menu <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	MenuDesc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	MenuGroup
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>NewMenu</span>(name, description <span style=color:#339;font-weight:700>string</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	<span style=color:#080;font-weight:700>return</span> <span style=color:#333>&amp;</span>Menu{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		MenuDesc: MenuDesc{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>			name:        name,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>			description: description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>}
</span></span></code></pre></div><h2 id=go-语言的思维方式>Go 语言的思维方式</h2><p>以下是本文的重点。使用 Go 语言开发项目 2 个多月，最大的感触就是：学习 Go 语言一定要转变思维方式，转变成功则其乐无穷，不能及时转变会发现自己处处碰壁。</p><p>下面让我们用真正 Go 的方式来实现 KFC 菜单。首先请默念三遍：没有继承，没有继承，没有继承；没有基类，没有基类，没有基类；接口只是函数签名的集合，接口只是函数签名的集合，接口只是函数签名的集合；struct 不依赖于接口，struct 不依赖于接口，struct 不依赖于接口。</p><p>好了，与之前不同，现在我们不是先定义接口再具体实现，因为 struct 不依赖于接口，所以我们直接实现具体功能。先是 <code>MenuDesc</code> 和 <code>MenuItem</code>，注意现在 <code>NewMenuItem</code> 的返回值类型是<code>*MenuItem</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> MenuDesc <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	name        <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	description <span style=color:#339;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuDesc) <span style=color:#06b;font-weight:700>Name</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#080;font-weight:700>return</span> m.name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuDesc) <span style=color:#06b;font-weight:700>Description</span>() <span style=color:#339;font-weight:700>string</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>	<span style=color:#080;font-weight:700>return</span> m.description
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#080;font-weight:700>type</span> MenuItem <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>	MenuDesc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	price <span style=color:#339;font-weight:700>float32</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>NewMenuItem</span>(name, description <span style=color:#339;font-weight:700>string</span>, price <span style=color:#339;font-weight:700>float32</span>) <span style=color:#333>*</span>MenuItem {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>	<span style=color:#080;font-weight:700>return</span> <span style=color:#333>&amp;</span>MenuItem{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>		MenuDesc: MenuDesc{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>			name:        name,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>			description: description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>		price: price,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Price</span>() <span style=color:#339;font-weight:700>float32</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>	<span style=color:#080;font-weight:700>return</span> m.price
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>MenuItem) <span style=color:#06b;font-weight:700>Print</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>	fmt.<span style=color:#06b;font-weight:700>Printf</span>(<span style=background-color:#fff0f0>&#34;  %s, ￥%.2f\n&#34;</span>, m.name, m.price)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>	fmt.<span style=color:#06b;font-weight:700>Printf</span>(<span style=background-color:#fff0f0>&#34;    -- %s\n&#34;</span>, m.description)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>}
</span></span></code></pre></div><p>接下来是 <code>MenuGroup</code>。我们知道 <code>MenuGroup</code> 是菜单/菜单项的集合，其 <code>children</code> 的类型是不确定的，于是我们知道这里需要定义一个接口。又因为 <code>MenuGroup</code> 的逻辑是对 <code>children</code> 进行增、删、读操作，对 <code>children</code> 的属性没有任何约束和要求，所以我们这里暂时把接口定义为空接口 <code>interface{}</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> MenuComponent <span style=color:#080;font-weight:700>interface</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#080;font-weight:700>type</span> MenuGroup <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>	children []MenuComponent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Add</span>(c MenuComponent) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	m.children = <span style=color:#007020>append</span>(m.children, c)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Remove</span>(idx <span style=color:#339;font-weight:700>int</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>	m.children = <span style=color:#007020>append</span>(m.children[:idx], m.children[idx<span style=color:#333>+</span><span style=color:#00d;font-weight:700>1</span>:]<span style=color:#333>...</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Child</span>(idx <span style=color:#339;font-weight:700>int</span>) MenuComponent {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>	<span style=color:#080;font-weight:700>return</span> m.children[idx]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><p>最后是 <code>Menu</code> 的实现：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;font-weight:700>type</span> Menu <span style=color:#080;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	MenuDesc
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	MenuGroup
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#080;font-weight:700>func</span> <span style=color:#06b;font-weight:700>NewMenu</span>(name, description <span style=color:#339;font-weight:700>string</span>) <span style=color:#333>*</span>Menu {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#080;font-weight:700>return</span> <span style=color:#333>&amp;</span>Menu{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>		MenuDesc: MenuDesc{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>			name:        name,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>			description: description,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		},
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Price</span>() (price <span style=color:#339;font-weight:700>float32</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>	<span style=color:#080;font-weight:700>for</span> _, v <span style=color:#333>:=</span> <span style=color:#080;font-weight:700>range</span> m.children {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>		price <span style=color:#333>+=</span> v.<span style=color:#06b;font-weight:700>Price</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>	<span style=color:#080;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#080;font-weight:700>func</span> (m <span style=color:#333>*</span>Menu) <span style=color:#06b;font-weight:700>Print</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>	fmt.<span style=color:#06b;font-weight:700>Printf</span>(<span style=background-color:#fff0f0>&#34;%s, %s, ￥%.2f\n&#34;</span>, m.name, m.description, m.<span style=color:#06b;font-weight:700>Price</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>	fmt.<span style=color:#06b;font-weight:700>Println</span>(<span style=background-color:#fff0f0>&#34;------------------------&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>	<span style=color:#080;font-weight:700>for</span> _, v <span style=color:#333>:=</span> <span style=color:#080;font-weight:700>range</span> m.children {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>		v.<span style=color:#06b;font-weight:700>Print</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>	fmt.<span style=color:#06b;font-weight:700>Println</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>}
</span></span></code></pre></div><p>在实现 <code>Menu</code> 的过程中，我们发现 <code>Menu</code> 对其 <code>children</code> 实际上有两个约束：需要有 <code>Price()</code> 方法和 <code>Print()</code> 方法。于是对 <code>MenuComponent</code> 进行修改：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#080;font-weight:700>type</span> MenuComponent <span style=color:#080;font-weight:700>interface</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	<span style=color:#06b;font-weight:700>Price</span>() <span style=color:#339;font-weight:700>float32</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	<span style=color:#06b;font-weight:700>Print</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>最后观察 <code>MenuItem</code> 和 <code>Menu</code>，它们都符合 <code>MenuComponent</code> 的约束，所以二者都可以成为 <code>Menu</code> 的 <code>children</code>，组合模式大功告成！</p><h2 id=比较与思考>比较与思考</h2><p>前后两份代码差异其实很小：</p><ol><li>第二份实现的接口简单一些，只有两个函数。</li><li>New 函数返回值的类型不一样。</li></ol><p>从思路上看，差异很大却也有些微妙：</p><ol><li>第一份实现中接口是模板，是 struct 的蓝图，其属性来源于事先对系统组件的综合分析归纳；第二份实现中接口是一份约束声明，其属性来源于使用者对被使用者的要求。</li><li>第一份实现认为 <code>children</code> 中的 <code>MenuComponent</code> 是一种具体对象，这个对象具有一系列方法可以调用，只是其方法的功能会由于子类覆盖而表现不同；第二份实现则认为 <code>children</code> 中的 <code>MenuComponent</code> 可以是任意无关的对象，唯一的要求是他们“恰巧”实现了接口所指定的约束条件。</li></ol><p>注意第一份实现中，<code>MenuComponent</code> 中有 <code>Add()</code>、<code>Remove()</code>、<code>Child()</code> 三个方法，但却不一定是可用的，能不能使用由具体对象的类型决定；第二份实现中则不存在这些不安全的方法，因为 New 函数返回的是具体类型，所以可以调用的方法都是安全的。</p><p>另外，从 <code>Menu</code> 中取出某个 child，其可用方法只有 <code>Price()</code> 和 <code>Print()</code>，一样可以完全安全的调用。如果想在 <code>MenuComponent</code> 是 <code>Menu</code> 的情况下往其中添加子项呢？很简单：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#080;font-weight:700>if</span> m, ok <span style=color:#333>:=</span> all.<span style=color:#06b;font-weight:700>Child</span>(<span style=color:#00d;font-weight:700>1</span>).(<span style=color:#333>*</span>Menu); ok {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	m.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;玩具&#34;</span>, <span style=background-color:#fff0f0>&#34;Hello Kitty&#34;</span>, <span style=color:#60e;font-weight:700>5.0</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>清晰明了，如果某 child 是一个 <code>Menu</code>，那么我们可以对其进行 <code>Add()</code> 操作。</p><p>更进一步，这里我们对类型的要求其实并没有那么强，并不需要它一定要是 <code>Menu</code>，只是需要其提供组合 <code>MenuComponent</code> 的功能，所以可以提炼出这样一个接口：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#080;font-weight:700>type</span> Group <span style=color:#080;font-weight:700>interface</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	<span style=color:#06b;font-weight:700>Add</span>(c MenuComponent)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	<span style=color:#06b;font-weight:700>Remove</span>(idx <span style=color:#339;font-weight:700>int</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>	<span style=color:#06b;font-weight:700>Child</span>(idx <span style=color:#339;font-weight:700>int</span>) MenuComponent
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><p>前面的添加子项的代码改成这样：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#080;font-weight:700>if</span> m, ok <span style=color:#333>:=</span> all.<span style=color:#06b;font-weight:700>Child</span>(<span style=color:#00d;font-weight:700>1</span>).(Group); ok {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	m.<span style=color:#06b;font-weight:700>Add</span>(<span style=color:#06b;font-weight:700>NewMenuItem</span>(<span style=background-color:#fff0f0>&#34;玩具&#34;</span>, <span style=background-color:#fff0f0>&#34;Hello Kitty&#34;</span>, <span style=color:#60e;font-weight:700>5.0</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>再考虑一下“购买”这个操作，面向对象的实现中，购买的类型是 <code>MenuComponent</code>，所以购买操作同时可以应用于 <code>Menu</code> 和 <code>MenuItem</code>。如果用 Go 语言的思维方式来考察，可购买对象的唯一要求是有 <code>Price()</code>，所以购买操作的参数是这样的接口：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#080;font-weight:700>type</span> Product <span style=color:#080;font-weight:700>interface</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	<span style=color:#06b;font-weight:700>Price</span>() <span style=color:#339;font-weight:700>float32</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>于是购买操作不仅可应用于 <code>Menu</code> 和 <code>MenuItem</code>，还可用于任何提供了价格的对象。我们可以任意添加产品，不论是玩具还是会员卡或者优惠券，只要有 <code>Price()</code> 方法就可以被购买。</p><h2 id=总结>总结</h2><p>最后总结一下我的思考：</p><ol><li>在组合模式中，一致性访问是个伪需求。一致性访问不是我们在设计时需要去满足的需求，而是当不同实体具有相同属性时自然产生的效果。上面的例子中，我们创建的是 menu 和 MenuItem 两种不同的类型，但由于它们具有相同属性，我们能以相同的方式取价格，取描述，加入 menu 成为子项。</li><li>Go 语言中的多态不体现在对象创建阶段，而体现在对象使用阶段，合理使用“小接口”能显著减少系统耦合度。</li></ol><p>PS. 本文所涉及的三份完整代码，我放在 play.golang.org 上了：（需翻墙）</p><ul><li>面向对象实现：<a href=http://play.golang.org/p/2DzGhVYseY>http://play.golang.org/p/2DzGhVYseY</a></li><li>使用组合：<a href=http://play.golang.org/p/KuH2Vu7f9k>http://play.golang.org/p/KuH2Vu7f9k</a></li><li>Go语言的思维方式：<a href=http://play.golang.org/p/TGjI3CDHD4>http://play.golang.org/p/TGjI3CDHD4</a></li></ul></div><hr><b>欢迎加入技术讨论 QQ 群：</b> 745157974<h4 class=page-header>Comments</h4><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//disksing.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><h4 class=page-header>Related</h4><div class=item><h4><a href=/try-go-generics/>Go语言泛型初体验</a></h4><h5>2022-03-11</h5><a href=http://disksing.com/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80><kbd class=item-tag>编程语言</kbd></a>
<a href=http://disksing.com/tags/go><kbd class=item-tag>Go</kbd></a></div><div class=item><h4><a href=/understanding-rust-ownership/>五句话理解 Rust 所有权</a></h4><h5>2020-02-08</h5><a href=http://disksing.com/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80><kbd class=item-tag>编程语言</kbd></a>
<a href=http://disksing.com/tags/rust><kbd class=item-tag>rust</kbd></a></div><div class=item><h4><a href=/go-singleton/>Go 语言设计模式：单例</a></h4><h5>最没意思的设计模式，Go 语言能玩出花样吗？</h5><a href=http://disksing.com/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80><kbd class=item-tag>编程语言</kbd></a></div></main><footer></footer><p class="copyright text-muted">&copy; 2014-2023 ALL RIGHTS RESERVED
|
本站由 <a href=https://gohugo.io>Hugo</a> 和 <a href=https://github.com/calintat/minimal>Minimal</a> 强力驱动
|
<a href=http://disksing.com/post/index.xml target=_blank><i class="fa fa-rss-square"></i>订阅本站文章</a> <a href=http://github.com/disksing/disksing.github.io/issues/new target=_blank><i class="fa fa-bug"></i>反馈问题</a><br>若无特别说明，本站文章采用 <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> 进行许可，文中涉及代码采用 <a rel=license href=http://creativecommons.org/publicdomain/zero/1.0/>CC0 1.0 Universal</a> 进行许可</p><script>MathJax={tex:{inlineMath:[["$","$"]],displayMath:[["$$","$$"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script></body></html>