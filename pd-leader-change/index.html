<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>PD leader 切换耗时分析</title>
<link rel=icon href=http://disksing.com/favicon.png>
<style>html body{font-family:noto serif sc,sans-serif;background-color:#fff}:root{--accent:red;--border-width:5px}</style>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto%20Serif%20SC">
<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous>
<link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous>
<link rel=stylesheet href=/css/main.css>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script>$(document).on('click',function(){$('.collapse').collapse('hide')})</script>
<meta name=generator content="Hugo 0.86.1">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154774927-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-154774927-1')</script>
<script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script data-ad-client=ca-pub-8963356574249468 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top">
<div class=container>
<div class=navbar-header>
<a class="navbar-brand visible-xs" href=#>PD leader 切换耗时分析</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
</div>
<div class="collapse navbar-collapse">
<ul class="nav navbar-nav">
<li><a href=/>主页</a></li>
<li><a href=/post/>文章</a></li>
<li><a href=/tip/>知识点</a></li>
<li><a href=/project/>开源项目</a></li>
<li><a href=/activity/>动态</a></li>
<li><a href=/about/>关于</a></li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li class=navbar-icon><a href=mailto:i@disksing.com><i class="fa fa-envelope-o"></i></a></li>
<li class=navbar-icon><a href=https://github.com/disksing/><i class="fa fa-github"></i></a></li>
<li class=navbar-icon><a href=http://weibo.com/539523448><i class="fa fa-weibo"></i></a></li>
<li class=navbar-icon><a href="http://shang.qq.com/wpa/qunwpa?idkey=ade2895067e4105ce59e0c56863d650543b4448245f179574c6684fe1cb7b5d5"><i class="fa fa-qq"></i></a></li>
<li class=navbar-icon><a href=https://space.bilibili.com/2207710><i class="fa fa-tv"></i></a></li>
<li class=navbar-icon><a href=https://twitter.com/disksing/><i class="fa fa-twitter"></i></a></li>
</ul>
</div>
</div>
</nav>
<main>
<div>
<h1>PD leader 切换耗时分析</h1>
<h5>2020-02-19</h5>
<a href=http://disksing.com/tags/tidb><kbd class=item-tag>TiDB</kbd></a>
</div>
<div align=start class=content><blockquote>
<p>本文首发在<a href=https://asktug.com/t/topic/2767>AskTUG.com</a>。</p>
</blockquote>
<p>我们知道，TiDB 集群中的多个 PD 提供的服务的方式是选出一个 PD 作为 leader 来提供服务的，当 leader 出现故障或者网络隔离后，其余的节点会自动通过 raft 选出新的 leader 继续服务。</p>
<p>从旧 leader 故障，到新 leader 选出并开始提供服务，这个过程服务是不可用的（比如 TSO 服务不可用，导致事务被 block），所以有必要分析这个过程的耗时并尽量使其缩短。</p>
<p>值得注意的是，PD 的配置有个相关的参数叫 lease，也就是 leader 的租约期限，默认值是 3s。那么，是否 leader 切换的耗时就是 3 秒呢？</p>
<p>实际我们观察到的往往比这个配置值要长不少，可能要 10 多秒甚至好几十秒，下面我们就来分析一下，时间都去哪儿了。</p>
<h2 id=流程分析>流程分析</h2>
<p><strong>1. etcd Leader 选举</strong></p>
<p>PD 的 leader 选举并非自己实现 raft，而是直接内嵌了 <a href=https://github.com/etcd-io/etcd/tree/master/embed>embedded etcd</a>，然后基于 etcd 提供的 lease 机制来实现 leader 选举。</p>
<p>内嵌 etcd 的好处是部署上比较简单，但是也带来了负面效果：如果 etcd 的 leader 在故障的节点上，PD 需要先等 etcd 选举出 leader 并恢复服务。</p>
<p>PD 配置中的 <code>election-interval</code> 用于控制 etcd 的选举超时时间，默认配置也是 3s。通常情况下，这一步耗时约为 3s，如果选举时出现分票的情况，可能还会稍长一些。</p>
<p><strong>2. PD leader lease 过期</strong></p>
<p>PD 竞选 leader 的机制是抢占式地往 etcd 的特定的 leader key 写入自己的 member id，并向 etcd 注册 lease。只要 leader 在线，会不断地更新 lease，也就能维持自己的 leader 角色。一旦发生故障或者隔离，etcd 的 LeaseManager 会在 lease 过期后删除这个 key，其他 PD 节点 watch 到 leader key 被删除之后会尝试把自己注册成新的 leader。</p>
<p>etcd 所管理的 lease 是在内存中倒计时的，不会实时地把剩余时间写入 raft 状态机，而是只存放了 TTL 信息。这带来一个问题，当 etcd leader 故障，新的节点成为 leader 后，无法得知之前的 lease 消耗了多少了，只能从头开始倒计时。而且 etcd 要恢复 leasor 时还会<a href=https://github.com/etcd-io/etcd/blob/d6a3c995cf86b479cb5a44b48d000feb33e3d8f8/etcdserver/server.go#L1976-L1980>多加一个 Election timeout</a>，（这里不太理解，可能是出于某种安全性的考虑？）</p>
<pre><code>// promote lessor when the local member is leader and finished
// applying all entries from the last term.
if s.isLeader() {
    s.lessor.Promote(s.Cfg.electionTimeout())
}
</code></pre><p>这样一来，TTL+electionTimeout 至少就有 6 秒了。实际测试这一步大约耗时在 6-8s。</p>
<p><strong>3. PD 竞选 leader</strong></p>
<p>当 PD watch 到 leader key 被 lease manager 删掉之后，则进入竞选状态，尝试将 leader key 设为自己的 member ID 并设置 lease。这一步通常很快就能完成。</p>
<p><strong>4. TSO 时钟同步</strong></p>
<p>PD 竞选成功后不能立即开始服务，需要确保分配的 ts 不能小于之前 leader 分配的 ts。首先 PD 会从 etcd 读出上一个 leader 可能分配过的最大 ts，接着检查本地时钟确保大于之前的 ts（如果不同 PD 之间时钟不同步，会需要 sleep 等待），最后再把当前时间+3s（可通过 <code>tso-save-interval</code> 调整）作为新的“可以分配的最大 ts” 持久化 etcd。</p>
<p>这一步的时间主要取决于时钟不同步的程度，如果正常开启 ntp 的话很快就能完成。</p>
<p><strong>5. 元信息加载</strong></p>
<p>除了 TSO，PD 还要为 TiDB 提供 Region 信息查询的功能。因此，PD 在开始服务之前，需要把所有 Regoin 元信息加载进内存。</p>
<p>这一步的时间主要跟 Region 的数量相关，如果集群规模不大对整体耗时的影响比较小，但是对于几百万 Region 的大集群，可能会需要长达几十秒。</p>
<h3 id=相关优化>相关优化</h3>
<p>切换 leader 的耗时是很值得优化的，毕竟作为集群的单点，PD 不可用的影响范围是整个集群。这里简单列举一下优化手段（包括规划中的）：</p>
<p><strong>1. 调小相关的 timeout 参数</strong></p>
<p>这个是很直接的方法，但是要注意过小的 timeout 可能会导致瞬间的网络抖动产生重新选举，尤其是跨机房的场景。</p>
<p><strong>2. 开启 PreVote</strong></p>
<p>这个主要是针对 etcd leader 选举的过程，开启 PreVote 可以使 leader 选举更稳定，降低选举时发生分票的概率。2.0.x 以上版本都是默认开启了 PreVote 的。</p>
<p><strong>3. TSO 不受系统时间影响</strong></p>
<p>这个优化其实不只针对不同节点间时间不一致的情况，也能解决手动调整系统时间产生的 TSO 暂停服务的问题。</p>
<p>简单来说，当可分配的 TS 超出当前的系统时间时，不再是直接停止服务，而是以很慢的速度递增 TS 的 physical 部分，直到系统时间追上来。</p>
<p>这个优化包含在 2.1.0 以上版本中。</p>
<p><strong>4. TSO 提前开始提供服务</strong></p>
<p>在 leader 切换的过程中，相对于 Region 信息服务，TSO 对可用性的影响更为致命，因为 TiDB 往往缓存了常用的 Region 信息，而且一部 Region 信息也能从 TiKV 更新，而 TSO 是没有任何旁路冗余的。</p>
<p>很自然的想法就是当 TSO 时钟同步完成后，不必等元信息加载完成，TSO 可以提前开始服务，这样可以一定程度上降低 leader 切换对整个集群的影响。</p>
<p>这个优化包含在 3.1.0 以上版本中。</p>
<p><strong>5. 提前加载 Region 元信息</strong></p>
<p>在 3.0.0 版本之后，为了支持大规模集群，PD 不再把 Region 存放在 etcd 中了，而是自行存储在文件系统并通过 <code>RegionSyncer</code> 组件同步给 Follower。</p>
<p>我们可以借助 <code>RegionSyncer</code> 在 Follower 上提前准备好 Region 的内在数据结构，等到 Follower 变成 Leader 之后，直接启用就行了，不需要加载的过程。</p>
<p>这个优化将在 4.0.0 版本提供出来。</p>
<p><strong>6. 不依赖于 etcd 自己实现 lease 机制</strong></p>
<p>有了上面那些优化之后，耗时的大头就落在前两个步骤了，也就是 etcd leader 选举和等待 leader lease 过期，它们加起来的耗时就可能达到 10 多秒。因此想进一步优化 leader 切换的耗时，不得不啃掉这块硬骨头了。</p>
<p>目前一个吸引了我们注意的方案是<a href=https://arxiv.org/pdf/1209.4187.pdf>Paxos lease</a>，不过这个事情要最终落地恐怕也没那么快，只能说值得期待吧。</p>
</div>
<hr>
<b>欢迎加入技术讨论 QQ 群： </b> 481269635 （硬盘在歌唱）
<h4 class=page-header>Comments</h4>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//disksing.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
<h4 class=page-header>Related</h4>
<div class=item>
<h4><a href=/truetime/>TrueTime和原子钟</a></h4>
<h5>2021-02-10</h5>
<a href=http://disksing.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F><kbd class=item-tag>分布式系统</kbd></a>
<a href=http://disksing.com/tags/tidb><kbd class=item-tag>TiDB</kbd></a>
</div>
<div class=item>
<h4><a href=/ya-hackathon-idea/>价值6万元的TiDB Hackathon创意</a></h4>
<h5>2020-12-17</h5>
<a href=http://disksing.com/tags/tidb><kbd class=item-tag>TiDB</kbd></a>
</div>
<div class=item>
<h4><a href=/hackathon-idea/>价值10万元的TiDB Hackathon创意</a></h4>
<h5>一般人我不告诉他</h5>
<a href=http://disksing.com/tags/tidb><kbd class=item-tag>TiDB</kbd></a>
</div>
</main>
<footer>
</footer>
<p class="copyright text-muted">
&copy; 2014-2021 ALL RIGHTS RESERVED
|
本站由 <a href=https://gohugo.io>Hugo</a> 和 <a href=https://github.com/calintat/minimal>Minimal</a> 强力驱动
|
<a href=http://disksing.com/post/index.xml target=_blank><i class="fa fa-rss-square"></i>订阅本站文章</a> <a href=http://github.com/disksing/disksing.github.io/issues/new target=_blank><i class="fa fa-bug"></i>反馈问题</a>
<br>
若无特别说明，本站文章采用 <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a> 进行许可，文中涉及代码采用 <a rel=license href=http://creativecommons.org/publicdomain/zero/1.0/>CC0 1.0 Universal</a> 进行许可
</p><script>MathJax={tex:{inlineMath:[['$','$']],displayMath:[['$$','$$']]},svg:{fontCache:'global'}}</script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script>
</body>
</html>